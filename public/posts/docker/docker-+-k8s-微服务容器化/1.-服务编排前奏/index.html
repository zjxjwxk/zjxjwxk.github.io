<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>微服务容器化系列（1）：服务编排前奏 | Xinkang&#39;s Blog</title>
<meta name="keywords" content="微服务架构, Docker">
<meta name="description" content="服务 Docker 化
修改项目配置
由于镜像运行时 MySQL 数据库所在的主机地址是动态的，所以将项目中的 MySQL 数据库地址和 Zookeeper 注册中心地址配置为动态变量：
spring: 
	dubbo:
		registry: zookeeper://${zk.address}:2181
	datasource:
		url: jdbc:mysql://{mysql.address}:3306/cinema?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8
获取 Java 镜像
docker pull openjdk:8-jre
打包 Maven 项目
在项目根目录下，执行 Maven 的清除和打包命令（跳过测试）：
mvn clean &amp;&amp; mvn package -Dmaven.test.skip=true
这样就会在 target 目录下生成 jar 包（Spring Boot 项目）。
编写 Dockerfile
在 user 子模块的根目录下，创建 Dockerfile 文件，并编辑如下，Dockerfile 文件用于构建 Docker 镜像：
FROM openjdk:8-jre
MAINTAINER zjxjwxk zjxjwxk@gmail.com

COPY target/user.jar /user.jar

ENTRYPOINT [&#34;java&#34;, &#34;-jar&#34;, &#34;/user.jar&#34;]
构建项目 Docker 镜像
docker build -t user:latest .
编写 build 脚本
在和 Dockerfile 同一目录下，创建一个 build.sh 脚本，用于打包和构建 Docker 镜像：">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/docker/docker-&#43;-k8s-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%B9%E5%99%A8%E5%8C%96/1.-%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92%E5%89%8D%E5%A5%8F/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/docker/docker-&#43;-k8s-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%B9%E5%99%A8%E5%8C%96/1.-%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92%E5%89%8D%E5%A5%8F/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Xinkang&#39;s Blog (Alt + H)">Xinkang&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      微服务容器化系列（1）：服务编排前奏
    </h1>
    <div class="post-meta"><span title='2020-06-04 23:15:00 +0000 UTC'>June 4, 2020</span>

</div>
  </header> 
  <div class="post-content"><h1 id="服务-docker-化">服务 Docker 化<a hidden class="anchor" aria-hidden="true" href="#服务-docker-化">#</a></h1>
<h2 id="修改项目配置">修改项目配置<a hidden class="anchor" aria-hidden="true" href="#修改项目配置">#</a></h2>
<p>由于镜像运行时 MySQL 数据库所在的主机地址是动态的，所以将项目中的 MySQL 数据库地址和 Zookeeper 注册中心地址配置为动态变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>: 
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">dubbo</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">registry</span>: <span style="color:#ae81ff">zookeeper://${zk.address}:2181</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">datasource</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">url</span>: <span style="color:#ae81ff">jdbc:mysql://{mysql.address}:3306/cinema?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
</span></span></code></pre></div><h2 id="获取-java-镜像">获取 Java 镜像<a hidden class="anchor" aria-hidden="true" href="#获取-java-镜像">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker pull openjdk:8-jre
</span></span></code></pre></div><h2 id="打包-maven-项目">打包 Maven 项目<a hidden class="anchor" aria-hidden="true" href="#打包-maven-项目">#</a></h2>
<p>在项目根目录下，执行 Maven 的清除和打包命令（跳过测试）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mvn clean <span style="color:#f92672">&amp;&amp;</span> mvn package -Dmaven.test.skip<span style="color:#f92672">=</span>true
</span></span></code></pre></div><p>这样就会在 target 目录下生成 jar 包（Spring Boot 项目）。</p>
<h2 id="编写-dockerfile">编写 Dockerfile<a hidden class="anchor" aria-hidden="true" href="#编写-dockerfile">#</a></h2>
<p>在 user 子模块的根目录下，创建 Dockerfile 文件，并编辑如下，Dockerfile 文件用于构建 Docker 镜像：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> openjdk:8-jre</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">MAINTAINER</span><span style="color:#e6db74"> zjxjwxk zjxjwxk@gmail.com</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> target/user.jar /user.jar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;java&#34;</span>, <span style="color:#e6db74">&#34;-jar&#34;</span>, <span style="color:#e6db74">&#34;/user.jar&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h2 id="构建项目-docker-镜像">构建项目 Docker 镜像<a hidden class="anchor" aria-hidden="true" href="#构建项目-docker-镜像">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker build -t user:latest .
</span></span></code></pre></div><h2 id="编写-build-脚本">编写 build 脚本<a hidden class="anchor" aria-hidden="true" href="#编写-build-脚本">#</a></h2>
<p>在和 Dockerfile 同一目录下，创建一个 build.sh 脚本，用于打包和构建 Docker 镜像：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mvn clean <span style="color:#f92672">&amp;&amp;</span> mvn package -Dmaven.test.skip<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>docker build -t user:latest .
</span></span></code></pre></div><h2 id="启动镜像容器">启动镜像容器<a hidden class="anchor" aria-hidden="true" href="#启动镜像容器">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run -it user:latest --mysql.address<span style="color:#f92672">=</span>172.20.10.3 --zk.address<span style="color:#f92672">=</span>172.20.10.3
</span></span></code></pre></div><p>注意：此处 <code>172.20.10.3</code> 为我的本机地址，可通过 ifconfig 查看（不可为 localhost 或 127.0.0.1，因为容器中的网络和本机是隔离的）。</p>
<h1 id="docker-下的服务通讯">Docker 下的服务通讯<a hidden class="anchor" aria-hidden="true" href="#docker-下的服务通讯">#</a></h1>
<p>Docker 容器之间的通讯有三种方法：</p>
<ol>
<li>通过容器的 IP 和端口直接访问（不稳定，容器在每次重启时 IP 可能发生变化）</li>
<li>通过主机和容器的端口映射来访问</li>
<li>使用 Docker 的 link 机制，通过名字来访问</li>
</ol>
<p>对于微服务之间，我们使用第 3 种方式；对于依赖的基础环境，如 MySQL、Zookeeper，我们使用第 2 种方式。</p>
<h2 id="建立服务之间的-link-关系">建立服务之间的 link 关系<a hidden class="anchor" aria-hidden="true" href="#建立服务之间的-link-关系">#</a></h2>
<h3 id="创建-docker-compose">创建 Docker Compose<a hidden class="anchor" aria-hidden="true" href="#创建-docker-compose">#</a></h3>
<p>Compose 是用于定义和运行多容器 Docker 应用程序的工具。通过 Compose，您可以使用 YML 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务。</p>
<p>在项目根目录创建一个 docker-compose.yml 文件，编辑如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cinema-user</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">cinema-user:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;--mysql.address=172.20.10.3 --zk.address=172.20.10.3&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cinema-film</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">cinema-film:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;--mysql.address=172.20.10.3 --zk.address=172.20.10.3&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cinema-cinema</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">cinema-cinema:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;--mysql.address=172.20.10.3 --zk.address=172.20.10.3&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cinema-order</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">cinema-order:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;--mysql.address=172.20.10.3 --zk.address=172.20.10.3&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">links</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">cinema-cinema</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cinema-alipay</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">cinema-alipay:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;--mysql.address=172.20.10.3 --zk.address=172.20.10.3&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">links</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">cinema-order</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cinema-gateway</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">cinema-gateway:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;--mysql.address=172.20.10.3 --zk.address=172.20.10.3&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">links</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">cinema-user</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">cinema-film</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">cinema-cinema</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">cinema-order</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">cinema-alipay</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">8081</span>:<span style="color:#ae81ff">8081</span>
</span></span></code></pre></div><p>其中，services 为所有需要构建的服务，command 为启动时添加的命令，links 为该服务依赖的服务。</p>
<h2 id="执行-docker-compose">执行 docker-compose<a hidden class="anchor" aria-hidden="true" href="#执行-docker-compose">#</a></h2>
<p>在有 docker-compose.sh 的目录下，</p>
<p>创建并运行所有容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker-compose up -d
</span></span></code></pre></div><p>关闭并删除所有容器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker-compose down
</span></span></code></pre></div><h1 id="镜像仓库">镜像仓库<a hidden class="anchor" aria-hidden="true" href="#镜像仓库">#</a></h1>
<h2 id="上传镜像">上传镜像<a hidden class="anchor" aria-hidden="true" href="#上传镜像">#</a></h2>
<p>登录 Docker，执行以下命令，并输入 Docker Hub 的账号密码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker login
</span></span></code></pre></div><p>将现有的镜像打个 tag：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker tag cinema-user:latest zjxjwxk/cinema-user:latest
</span></span></code></pre></div><p>将该镜像 push 到 Docker Hub：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker push zjxjwxk/cinema-user:latest
</span></span></code></pre></div><p>或是将镜像从 Docker Hub pull 下来：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker pull zjxjwxk/cinema-user:latest
</span></span></code></pre></div><h2 id="使用-harbor">使用 harbor<a hidden class="anchor" aria-hidden="true" href="#使用-harbor">#</a></h2>
<p>从 <a href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a> 下载 harbor-offline-installer，解压之。</p>
<h3 id="配置-harboryml">配置 harbor.yml<a hidden class="anchor" aria-hidden="true" href="#配置-harboryml">#</a></h3>
<p>配置其目录下的 <code>harbor.yml</code> ：</p>
<p>将其中的 <code>hostname</code> 为 hub.xxx.com（xxx 为你的域名）。将 <code>http</code> 的 <code>port</code> 修改为 8080（由于 MacOS 80 端口不对外开放）。</p>
<p>如果是 MacOS 系统，还需要将其中本机 host 相关的目录由根目录 <code>/</code> 改为 <code>/Users/xxx/</code> (xxx 为你当前系统的用户名)，避免挂载权限不足的问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#75715e"># Configuration file of Harbor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The IP address or hostname to access admin UI and registry service.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">hub.zjxjwxk.com</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># http related config</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># port for http, default is 80. If https enabled, this port will redirect to https port</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https related config</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#https:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># https port for harbor, default is 443</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  port: 443</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The path of cert and key files for nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  certificate: /your/certificate/path</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  private_key: /your/private/key/path</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Uncomment external_url if you want to enable external proxy</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># And when it enabled the hostname will no longer used</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># external_url: https://reg.mydomain.com:8433</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The initial password of Harbor admin</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># It only works in first time to install harbor</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remember Change the admin password from UI after launching Harbor.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">harbor_admin_password</span>: <span style="color:#ae81ff">Harbor12345</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Harbor DB configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">database</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The password for the root user of Harbor DB. Change this before any production use.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: <span style="color:#ae81ff">root123</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The maximum number of connections in the idle connection pool. If it &lt;=0, no idle connections are retained.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_idle_conns</span>: <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The maximum number of open connections to the database. If it &lt;= 0, then there is no limit on the number of open connections.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Note: the default number of connections is 100 for postgres.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_open_conns</span>: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The default data volume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data_volume</span>: <span style="color:#ae81ff">/Users/zjxjwxk/data</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Harbor Storage settings by default is using /data dir on local filesystem</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Uncomment storage_service setting If you want to using external storage</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># storage_service:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   # ca_bundle is the path to the custom root ca certificate, which will be injected into the truststore</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   # of registry&#39;s and chart repository&#39;s containers.  This is usually needed when the user hosts a internal storage with self signed certificate.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   ca_bundle:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   # storage backend, default is filesystem, options include filesystem, azure, gcs, s3, swift and oss</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   # for more info about this configuration please refer https://docs.docker.com/registry/configuration/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   filesystem:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     maxthreads: 100</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   # set disable to true when you want to disable registry redirect</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   redirect:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     disabled: false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Clair configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clair</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># The interval of clair updaters, the unit is hour, set to 0 to disable the updaters.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updaters_interval</span>: <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">jobservice</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Maximum number of job workers in job service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_job_workers</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">notification</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Maximum retry count for webhook job</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">webhook_job_max_retry</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">chart</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Change the value of absolute_url to enabled can enable absolute url in chart</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">absolute_url</span>: <span style="color:#ae81ff">disabled</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Log configurations</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">log</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># options are debug, info, warning, error, fatal</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">level</span>: <span style="color:#ae81ff">info</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># configs for logs in local storage</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Log files are rotated log_rotate_count times before being removed. If count is 0, old versions are removed rather than rotated.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rotate_count</span>: <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Log files are rotated only if they grow bigger than log_rotate_size bytes. If size is followed by k, the size is assumed to be in kilobytes.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># If the M is used, the size is in megabytes, and if G is used, the size is in gigabytes. So size 100, size 100k, size 100M and size 100G</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># are all valid.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rotate_size</span>: <span style="color:#ae81ff">200M</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># The directory on your host that store log</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">location</span>: <span style="color:#ae81ff">/Users/zjxjwxk/var/log/harbor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Uncomment following lines to enable external syslog endpoint.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># external_endpoint:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#   # protocol used to transmit log to external endpoint, options is tcp or udp</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#   protocol: tcp</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#   # The host of external endpoint</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#   host: localhost</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#   # Port of external endpoint</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#   port: 5140</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#This attribute is for migrator to detect the version of the .cfg file, DO NOT MODIFY!</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">_version</span>: <span style="color:#ae81ff">1.10.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Uncomment external_database if using external database.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># external_database:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   harbor:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     host: harbor_db_host</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     port: harbor_db_port</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     db_name: harbor_db_name</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     username: harbor_db_username</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     password: harbor_db_password</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     ssl_mode: disable</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     max_idle_conns: 2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     max_open_conns: 0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   clair:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     host: clair_db_host</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     port: clair_db_port</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     db_name: clair_db_name</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     username: clair_db_username</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     password: clair_db_password</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     ssl_mode: disable</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   notary_signer:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     host: notary_signer_db_host</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     port: notary_signer_db_port</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     db_name: notary_signer_db_name</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     username: notary_signer_db_username</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     password: notary_signer_db_password</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     ssl_mode: disable</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   notary_server:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     host: notary_server_db_host</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     port: notary_server_db_port</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     db_name: notary_server_db_name</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     username: notary_server_db_username</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     password: notary_server_db_password</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     ssl_mode: disable</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Uncomment external_redis if using external Redis server</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># external_redis:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   host: redis</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   port: 6379</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   password:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   # db_index 0 is for core, it&#39;s unchangeable</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   registry_db_index: 1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   jobservice_db_index: 2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   chartmuseum_db_index: 3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   clair_db_index: 4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Uncomment uaa for trusting the certificate of uaa instance that is hosted via self-signed cert.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># uaa:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   ca_file: /path/to/ca</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Global proxy</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Config http proxy for components, e.g. http://my.proxy.com:3128</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Components doesn&#39;t need to connect to each others via http proxy.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remove component from `components` array if want disable proxy</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for it. If you want use proxy for replication, MUST enable proxy</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for core and jobservice, and set `http_proxy` and `https_proxy`.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add domain to the `no_proxy` field, when you want disable proxy</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for some special registry.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">proxy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">http_proxy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">https_proxy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># no_proxy endpoints will appended to 127.0.0.1,localhost,.local,.internal,log,db,redis,nginx,core,portal,postgresql,jobservice,registry,registryctl,clair,chartmuseum,notary-server</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">no_proxy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">components</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">core</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">jobservice</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">clair</span>
</span></span></code></pre></div><h3 id="启动-harbar">启动 harbar<a hidden class="anchor" aria-hidden="true" href="#启动-harbar">#</a></h3>
<p>执行 <code>sh install.sh</code> 运行 harbar。</p>
<p>出现以下则说明启动成功：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>Step 5<span style="color:#f92672">]</span>: starting Harbor ...
</span></span><span style="display:flex;"><span>Creating network <span style="color:#e6db74">&#34;harbor_harbor&#34;</span> with the default driver
</span></span><span style="display:flex;"><span>Creating harbor-log ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Creating redis         ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Creating harbor-portal ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Creating registryctl   ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Creating harbor-db     ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Creating registry      ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Creating harbor-core   ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Creating nginx             ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Creating harbor-jobservice ... <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>✔ ----Harbor has been installed and started successfully.----
</span></span></code></pre></div><p>访问 localhost:8080 进入 Harbor UI 界面。默认账号为 admin，默认密码为 <code>harbor.yml</code> 中的 <code>harbor_admin_password</code> : Harbor12345。</p>
<p><img alt="Harbor 界面" loading="lazy" src="/posts/docker/docker-+-k8s-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%B9%E5%99%A8%E5%8C%96/1.-%E6%9C%8D%E5%8A%A1%E7%BC%96%E6%8E%92%E5%89%8D%E5%A5%8F/images/image-20200611004219372.png"></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/">微服务架构</a></li>
      <li><a href="http://localhost:1313/tags/docker/">Docker</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Xinkang&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
