<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Dubbo微服务影院系列（5）：Dubbo基本特性（用户模块开发） | Xinkang&#39;s Blog</title>
<meta name="keywords" content="Dubbo, 微服务架构">
<meta name="description" content="章节概要

学会 API 网关权限验证和其他服务交互
学会开发 SpringBoot 的自定义配置
学会 Dubbo 负载均衡策略选择和使用

修改 Guns 中的 JWT 模块

增加忽略验证 URL 配置
修改返回内容匹配业务
增加 Threadlocal 的用户信息保存

业务功能开发

增加用户服务并提供接口
初步了解 API 网关与服务之间交互的过程
根据接口文档开发用户接口

创建用户表
DROP TABLE IF EXISTS user;
CREATE TABLE user(
   UUID INT PRIMARY KEY AUTO_INCREMENT COMMENT &#39;主键编号&#39;,
   user_name VARCHAR(50) COMMENT &#39;用户账号&#39;,
   user_pwd VARCHAR(50) COMMENT &#39;用户密码&#39;,
   nick_name VARCHAR(50) COMMENT &#39;用户昵称&#39;,
   user_sex INT COMMENT &#39;用户性别 0-男，1-女&#39;,
   birthday VARCHAR(50) COMMENT &#39;出生日期&#39;,
   email VARCHAR(50) COMMENT &#39;用户邮箱&#39;,
   user_phone VARCHAR(50) COMMENT &#39;用户手机号&#39;,
   address VARCHAR(50) COMMENT &#39;用户住址&#39;,
   head_url VARCHAR(50) COMMENT &#39;头像URL&#39;,
   biography VARCHAR(200) COMMENT &#39;个人介绍&#39;,
   life_state INT COMMENT &#39;生活状态 0-单身，1-热恋中，2-已婚，3-为人父母&#39;,
   begin_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,
   update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39;
) COMMENT &#39;用户表&#39; ENGINE = INNODB AUTO_INCREMENT = 2 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = DYNAMIC;

insert into user(user_name,user_pwd,nick_name,user_sex,birthday,email,user_phone,address,head_url,life_state,biography) values(&#39;admin&#39;,&#39;0192023a7bbd73250516f069df18b500&#39;,&#39;管理员&#39;,0,&#39;2018-07-31&#39;,&#39;admin@gmail.com&#39;,&#39;13888888888&#39;,&#39;浙江省杭州市西湖区某路某号&#39;,&#39;cinema/img/head-img.jpg&#39;,0,&#39;我是苦逼的管理员&#39;);
insert into user(user_name,user_pwd,nick_name,user_sex,birthday,email,user_phone,address,head_url,life_state,biography) values(&#39;test&#39;,&#39;5e2de6bd1c9b50f6e27d4e55da43b917&#39;,&#39;测试用户&#39;,0,&#39;2018-08-20&#39;,&#39;test@gmail.com&#39;,&#39;13866666666&#39;,&#39;测试地址&#39;,&#39;cinema/img/head-img.jpg&#39;,1,&#39;我是测试用户&#39;);
用户服务与网关交互
在 guns 项目中复制一份 guns-gateway 模块并重命名为 guns-user（修改相应子模块和主模块的 pom.xml 等），并在 application.yml 中将其鉴权机制等关闭（网关才需要）">
<meta name="author" content="">
<link rel="canonical" href="https://zjxjwxk.github.io/posts/dubbo/dubbo%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BD%B1%E9%99%A2%E7%B3%BB%E5%88%97/5.dubbo%E5%9F%BA%E6%9C%AC%E7%89%B9%E6%80%A7%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://zjxjwxk.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://zjxjwxk.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://zjxjwxk.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://zjxjwxk.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://zjxjwxk.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://zjxjwxk.github.io/posts/dubbo/dubbo%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BD%B1%E9%99%A2%E7%B3%BB%E5%88%97/5.dubbo%E5%9F%BA%E6%9C%AC%E7%89%B9%E6%80%A7%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://zjxjwxk.github.io/posts/dubbo/dubbo%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BD%B1%E9%99%A2%E7%B3%BB%E5%88%97/5.dubbo%E5%9F%BA%E6%9C%AC%E7%89%B9%E6%80%A7%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/">
  <meta property="og:site_name" content="Xinkang&#39;s Blog">
  <meta property="og:title" content="Dubbo微服务影院系列（5）：Dubbo基本特性（用户模块开发）">
  <meta property="og:description" content="章节概要 学会 API 网关权限验证和其他服务交互 学会开发 SpringBoot 的自定义配置 学会 Dubbo 负载均衡策略选择和使用 修改 Guns 中的 JWT 模块 增加忽略验证 URL 配置 修改返回内容匹配业务 增加 Threadlocal 的用户信息保存 业务功能开发 增加用户服务并提供接口 初步了解 API 网关与服务之间交互的过程 根据接口文档开发用户接口 创建用户表 DROP TABLE IF EXISTS user; CREATE TABLE user( UUID INT PRIMARY KEY AUTO_INCREMENT COMMENT &#39;主键编号&#39;, user_name VARCHAR(50) COMMENT &#39;用户账号&#39;, user_pwd VARCHAR(50) COMMENT &#39;用户密码&#39;, nick_name VARCHAR(50) COMMENT &#39;用户昵称&#39;, user_sex INT COMMENT &#39;用户性别 0-男，1-女&#39;, birthday VARCHAR(50) COMMENT &#39;出生日期&#39;, email VARCHAR(50) COMMENT &#39;用户邮箱&#39;, user_phone VARCHAR(50) COMMENT &#39;用户手机号&#39;, address VARCHAR(50) COMMENT &#39;用户住址&#39;, head_url VARCHAR(50) COMMENT &#39;头像URL&#39;, biography VARCHAR(200) COMMENT &#39;个人介绍&#39;, life_state INT COMMENT &#39;生活状态 0-单身，1-热恋中，2-已婚，3-为人父母&#39;, begin_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;, update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39; ) COMMENT &#39;用户表&#39; ENGINE = INNODB AUTO_INCREMENT = 2 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = DYNAMIC; insert into user(user_name,user_pwd,nick_name,user_sex,birthday,email,user_phone,address,head_url,life_state,biography) values(&#39;admin&#39;,&#39;0192023a7bbd73250516f069df18b500&#39;,&#39;管理员&#39;,0,&#39;2018-07-31&#39;,&#39;admin@gmail.com&#39;,&#39;13888888888&#39;,&#39;浙江省杭州市西湖区某路某号&#39;,&#39;cinema/img/head-img.jpg&#39;,0,&#39;我是苦逼的管理员&#39;); insert into user(user_name,user_pwd,nick_name,user_sex,birthday,email,user_phone,address,head_url,life_state,biography) values(&#39;test&#39;,&#39;5e2de6bd1c9b50f6e27d4e55da43b917&#39;,&#39;测试用户&#39;,0,&#39;2018-08-20&#39;,&#39;test@gmail.com&#39;,&#39;13866666666&#39;,&#39;测试地址&#39;,&#39;cinema/img/head-img.jpg&#39;,1,&#39;我是测试用户&#39;); 用户服务与网关交互 在 guns 项目中复制一份 guns-gateway 模块并重命名为 guns-user（修改相应子模块和主模块的 pom.xml 等），并在 application.yml 中将其鉴权机制等关闭（网关才需要）">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-03-11T23:45:00+00:00">
    <meta property="article:modified_time" content="2020-03-11T23:45:00+00:00">
    <meta property="article:tag" content="Dubbo">
    <meta property="article:tag" content="微服务架构">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dubbo微服务影院系列（5）：Dubbo基本特性（用户模块开发）">
<meta name="twitter:description" content="章节概要

学会 API 网关权限验证和其他服务交互
学会开发 SpringBoot 的自定义配置
学会 Dubbo 负载均衡策略选择和使用

修改 Guns 中的 JWT 模块

增加忽略验证 URL 配置
修改返回内容匹配业务
增加 Threadlocal 的用户信息保存

业务功能开发

增加用户服务并提供接口
初步了解 API 网关与服务之间交互的过程
根据接口文档开发用户接口

创建用户表
DROP TABLE IF EXISTS user;
CREATE TABLE user(
   UUID INT PRIMARY KEY AUTO_INCREMENT COMMENT &#39;主键编号&#39;,
   user_name VARCHAR(50) COMMENT &#39;用户账号&#39;,
   user_pwd VARCHAR(50) COMMENT &#39;用户密码&#39;,
   nick_name VARCHAR(50) COMMENT &#39;用户昵称&#39;,
   user_sex INT COMMENT &#39;用户性别 0-男，1-女&#39;,
   birthday VARCHAR(50) COMMENT &#39;出生日期&#39;,
   email VARCHAR(50) COMMENT &#39;用户邮箱&#39;,
   user_phone VARCHAR(50) COMMENT &#39;用户手机号&#39;,
   address VARCHAR(50) COMMENT &#39;用户住址&#39;,
   head_url VARCHAR(50) COMMENT &#39;头像URL&#39;,
   biography VARCHAR(200) COMMENT &#39;个人介绍&#39;,
   life_state INT COMMENT &#39;生活状态 0-单身，1-热恋中，2-已婚，3-为人父母&#39;,
   begin_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,
   update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39;
) COMMENT &#39;用户表&#39; ENGINE = INNODB AUTO_INCREMENT = 2 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = DYNAMIC;

insert into user(user_name,user_pwd,nick_name,user_sex,birthday,email,user_phone,address,head_url,life_state,biography) values(&#39;admin&#39;,&#39;0192023a7bbd73250516f069df18b500&#39;,&#39;管理员&#39;,0,&#39;2018-07-31&#39;,&#39;admin@gmail.com&#39;,&#39;13888888888&#39;,&#39;浙江省杭州市西湖区某路某号&#39;,&#39;cinema/img/head-img.jpg&#39;,0,&#39;我是苦逼的管理员&#39;);
insert into user(user_name,user_pwd,nick_name,user_sex,birthday,email,user_phone,address,head_url,life_state,biography) values(&#39;test&#39;,&#39;5e2de6bd1c9b50f6e27d4e55da43b917&#39;,&#39;测试用户&#39;,0,&#39;2018-08-20&#39;,&#39;test@gmail.com&#39;,&#39;13866666666&#39;,&#39;测试地址&#39;,&#39;cinema/img/head-img.jpg&#39;,1,&#39;我是测试用户&#39;);
用户服务与网关交互
在 guns 项目中复制一份 guns-gateway 模块并重命名为 guns-user（修改相应子模块和主模块的 pom.xml 等），并在 application.yml 中将其鉴权机制等关闭（网关才需要）">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://zjxjwxk.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Dubbo微服务影院系列（5）：Dubbo基本特性（用户模块开发）",
      "item": "https://zjxjwxk.github.io/posts/dubbo/dubbo%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BD%B1%E9%99%A2%E7%B3%BB%E5%88%97/5.dubbo%E5%9F%BA%E6%9C%AC%E7%89%B9%E6%80%A7%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Dubbo微服务影院系列（5）：Dubbo基本特性（用户模块开发）",
  "name": "Dubbo微服务影院系列（5）：Dubbo基本特性（用户模块开发）",
  "description": "章节概要 学会 API 网关权限验证和其他服务交互 学会开发 SpringBoot 的自定义配置 学会 Dubbo 负载均衡策略选择和使用 修改 Guns 中的 JWT 模块 增加忽略验证 URL 配置 修改返回内容匹配业务 增加 Threadlocal 的用户信息保存 业务功能开发 增加用户服务并提供接口 初步了解 API 网关与服务之间交互的过程 根据接口文档开发用户接口 创建用户表 DROP TABLE IF EXISTS user; CREATE TABLE user( UUID INT PRIMARY KEY AUTO_INCREMENT COMMENT \u0026#39;主键编号\u0026#39;, user_name VARCHAR(50) COMMENT \u0026#39;用户账号\u0026#39;, user_pwd VARCHAR(50) COMMENT \u0026#39;用户密码\u0026#39;, nick_name VARCHAR(50) COMMENT \u0026#39;用户昵称\u0026#39;, user_sex INT COMMENT \u0026#39;用户性别 0-男，1-女\u0026#39;, birthday VARCHAR(50) COMMENT \u0026#39;出生日期\u0026#39;, email VARCHAR(50) COMMENT \u0026#39;用户邮箱\u0026#39;, user_phone VARCHAR(50) COMMENT \u0026#39;用户手机号\u0026#39;, address VARCHAR(50) COMMENT \u0026#39;用户住址\u0026#39;, head_url VARCHAR(50) COMMENT \u0026#39;头像URL\u0026#39;, biography VARCHAR(200) COMMENT \u0026#39;个人介绍\u0026#39;, life_state INT COMMENT \u0026#39;生活状态 0-单身，1-热恋中，2-已婚，3-为人父母\u0026#39;, begin_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;创建时间\u0026#39;, update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT \u0026#39;修改时间\u0026#39; ) COMMENT \u0026#39;用户表\u0026#39; ENGINE = INNODB AUTO_INCREMENT = 2 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = DYNAMIC; insert into user(user_name,user_pwd,nick_name,user_sex,birthday,email,user_phone,address,head_url,life_state,biography) values(\u0026#39;admin\u0026#39;,\u0026#39;0192023a7bbd73250516f069df18b500\u0026#39;,\u0026#39;管理员\u0026#39;,0,\u0026#39;2018-07-31\u0026#39;,\u0026#39;admin@gmail.com\u0026#39;,\u0026#39;13888888888\u0026#39;,\u0026#39;浙江省杭州市西湖区某路某号\u0026#39;,\u0026#39;cinema/img/head-img.jpg\u0026#39;,0,\u0026#39;我是苦逼的管理员\u0026#39;); insert into user(user_name,user_pwd,nick_name,user_sex,birthday,email,user_phone,address,head_url,life_state,biography) values(\u0026#39;test\u0026#39;,\u0026#39;5e2de6bd1c9b50f6e27d4e55da43b917\u0026#39;,\u0026#39;测试用户\u0026#39;,0,\u0026#39;2018-08-20\u0026#39;,\u0026#39;test@gmail.com\u0026#39;,\u0026#39;13866666666\u0026#39;,\u0026#39;测试地址\u0026#39;,\u0026#39;cinema/img/head-img.jpg\u0026#39;,1,\u0026#39;我是测试用户\u0026#39;); 用户服务与网关交互 在 guns 项目中复制一份 guns-gateway 模块并重命名为 guns-user（修改相应子模块和主模块的 pom.xml 等），并在 application.yml 中将其鉴权机制等关闭（网关才需要）\n",
  "keywords": [
    "Dubbo", "微服务架构"
  ],
  "articleBody": "章节概要 学会 API 网关权限验证和其他服务交互 学会开发 SpringBoot 的自定义配置 学会 Dubbo 负载均衡策略选择和使用 修改 Guns 中的 JWT 模块 增加忽略验证 URL 配置 修改返回内容匹配业务 增加 Threadlocal 的用户信息保存 业务功能开发 增加用户服务并提供接口 初步了解 API 网关与服务之间交互的过程 根据接口文档开发用户接口 创建用户表 DROP TABLE IF EXISTS user; CREATE TABLE user( UUID INT PRIMARY KEY AUTO_INCREMENT COMMENT '主键编号', user_name VARCHAR(50) COMMENT '用户账号', user_pwd VARCHAR(50) COMMENT '用户密码', nick_name VARCHAR(50) COMMENT '用户昵称', user_sex INT COMMENT '用户性别 0-男，1-女', birthday VARCHAR(50) COMMENT '出生日期', email VARCHAR(50) COMMENT '用户邮箱', user_phone VARCHAR(50) COMMENT '用户手机号', address VARCHAR(50) COMMENT '用户住址', head_url VARCHAR(50) COMMENT '头像URL', biography VARCHAR(200) COMMENT '个人介绍', life_state INT COMMENT '生活状态 0-单身，1-热恋中，2-已婚，3-为人父母', begin_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间', update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间' ) COMMENT '用户表' ENGINE = INNODB AUTO_INCREMENT = 2 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = DYNAMIC; insert into user(user_name,user_pwd,nick_name,user_sex,birthday,email,user_phone,address,head_url,life_state,biography) values('admin','0192023a7bbd73250516f069df18b500','管理员',0,'2018-07-31','admin@gmail.com','13888888888','浙江省杭州市西湖区某路某号','cinema/img/head-img.jpg',0,'我是苦逼的管理员'); insert into user(user_name,user_pwd,nick_name,user_sex,birthday,email,user_phone,address,head_url,life_state,biography) values('test','5e2de6bd1c9b50f6e27d4e55da43b917','测试用户',0,'2018-08-20','test@gmail.com','13866666666','测试地址','cinema/img/head-img.jpg',1,'我是测试用户'); 用户服务与网关交互 在 guns 项目中复制一份 guns-gateway 模块并重命名为 guns-user（修改相应子模块和主模块的 pom.xml 等），并在 application.yml 中将其鉴权机制等关闭（网关才需要）\nrest: auth-open: false #jwt鉴权机制是否开启(true或者false) sign-open: false #签名机制是否开启(true或false) 端口设为8083\nserver: port: 8083 #项目端口 在 spring:dubbo: 下添加 Dubbo 协议和端口（UserApplication 需要向外部暴露接口，先向注册中心注册，然后通过 Dubbo 协议被远程调用）\nspring: application: name: cinema-user dubbo: server: true registry: zookeeper://localhost:2181 protocol: name: dubbo port: 20881 在 guns-user 中编写 UserAPI 的实现类，其中 UserAPI 接口是来自于 guns-api 的（在前一章已经做了业务 API 抽离），并通过 @Service 向外部暴露\n@Component @Service(interfaceClass = UserAPI.class) public class UserImpl implements UserAPI { @Override public boolean login(String username, String password) { System.out.println(\"This is user service! \" + username + \", \" + password); return false; } } 然后，在 guns-gateway 中就可以远程调用 UserAPI 接口了\n@Reference(interfaceClass = UserAPI.class) private UserAPI userAPI; userAPI.login(username, password); 基于 SpringBoot 配置忽略列表 配置 guns-gateway 网关模块中的 application.yml，在 jwt 下添加 ignore-url 配置，用逗号分隔 url（注意不能有空格！），这些接口将不通过 jwt 验证过滤器\njwt: header: Authorization #http请求头所需要的字段 secret: mySecret #jwt秘钥 expiration: 604800 #7天 单位:秒 auth-path: auth #认证请求的路径 md5-key: randomKey #md5加密混淆key ignore-url: /user/,/film/ #忽略列表 在 JwtProperties 中添加一项成员变量，并添加 get、set 函数，这个类是配置类，@ConfigurationProperties(prefix = JwtProperties.JWT_PREFIX) 表示用于从配置文件 application.yml 中获取 jwt 开头的配置变量\n@Configuration @ConfigurationProperties(prefix = JwtProperties.JWT_PREFIX) public class JwtProperties { public static final String JWT_PREFIX = \"jwt\"; private String header = \"Authorization\"; private String secret = \"defaultSecret\"; private Long expiration = 604800L; private String authPath = \"auth\"; private String md5Key = \"randomKey\"; private String ignoreUrl = \"\"; 在 AuthFilter 的 doFilterInternal 方法中添加以下代码，用于忽略配置列表\n// 配置忽略列表 String ignoreUrl = jwtProperties.getIgnoreUrl(); String[] ignoreUrls = ignoreUrl.split(\",\"); for (int i = 0; i \u003c ignoreUrls.length; i++) { if (request.getServletPath().equals(ignoreUrls[i])) { chain.doFilter(request, response); return; } } 修改 JWT 申请的返回报文 在 guns-gateway 模块中的 modular.vo 下，创建 ResponseVO 类作为响应VO类，其中包含了三种状态 Status ：0-成功，1-业务失败，999-系统异常\npublic class ResponseVO\u003cM\u003e { /** * 返回状态 [0-成功，1-业务失败，999-系统异常] */ private Integer status; /** * 返回信息 */ private String msg; /** * 返回数据实体 */ private M data; private ResponseVO() {} public static\u003cM\u003e ResponseVO success(M m) { ResponseVO responseVO = new ResponseVO(); responseVO.setStatus(0); responseVO.setData(m); return responseVO; } public static ResponseVO serviceFail(String msg) { ResponseVO responseVO = new ResponseVO(); responseVO.setStatus(1); responseVO.setMsg(msg); return responseVO; } public static ResponseVO appFail(String msg) { ResponseVO responseVO = new ResponseVO(); responseVO.setStatus(999); responseVO.setMsg(msg); return responseVO; } 之后在 AuthController 中就可以用该类作为返回对象了\n@RequestMapping(value = \"${jwt.auth-path}\") public ResponseVO createAuthenticationToken(AuthRequest authRequest) { boolean validate = true; // 去掉guns自身携带的用户名密码验证机制，使用自己的 int userId = userAPI.login(authRequest.getUserName(), authRequest.getPassword()); if (userId == 0) { validate = false; } if (validate) { // randomKey和token已经生成完毕 final String randomKey = jwtTokenUtil.getRandomKey(); final String token = jwtTokenUtil.generateToken(\"\" + userId, randomKey); // 返回值 return ResponseVO.success(new AuthResponse(token, randomKey)); } else { return ResponseVO.serviceFail(\"用户名或密码错误\"); } } 增加 Threadlocal 的用户信息保存 在 guns-gateway 中的 common 下创建 CurrentUser 类用于保存 userId（不直接保存 userInfoModel 是因为更省空间，避免用户量大时出现内存溢出），该 userId 存在 ThreadLocal 中和线程绑定，同一线程内共享\npublic class CurrentUser { /** * 线程绑定的存储空间 */ private static final ThreadLocal\u003cString\u003e threadLocal = new ThreadLocal\u003c\u003e(); public static void saveUserId(String userId) { threadLocal.set(userId); } public static String getCurrentUser() { return threadLocal.get(); } } 之后，在 AuthFilter 验证 token 时，就可以通过 token 获取 userID，并且将之存入 ThreadLocal，以便后续业务调用了\nString userId = jwtTokenUtil.getUsernameFromToken(authToken); if (userId == null) { return; } else { CurrentUser.saveUserId(userId); } 在用户后续访问时，就可以取出 userId，并从数据库或 redis 中获取用户信息了\n@Controller @RequestMapping(\"/hello\") public class ExampleController { @RequestMapping(\"\") public ResponseEntity hello() { System.out.println(CurrentUser.getCurrentUser()); // 这里将以userId为key，userInfo为value存在redis中，TTL为30分钟 // 或以userId为条件去数据库取出（和redis只有快慢的区别） return ResponseEntity.ok(\"请求成功!\"); } } 用户模块开发 业务功能开发流程 使用代码生成器生成数据项 在每个 guns 模块的 test 下，都有 enerator.EntityGenerator 这个用于实体生成的类，只需根据需要稍微修改一下方法的参数即可。在 guns-user 模块中生成即可得到：UserT, UserTMapper, UserTMapper.xml\n... // 生成代码的绝对目录 gc.setOutputDir(\"/Users/zjxjwxk/Documents/GitHub/Cinema-Dubbo/guns-user/src/main/java\"); ... // 作者信息 gc.setAuthor(\"zjxjwxk\"); ... // 数据库连接配置 dsc.setUsername(\"root\"); dsc.setPassword(\"19981018\"); dsc.setUrl(\"jdbc:mysql://127.0.0.1:3306/guns_rest?autoReconnect=true\u0026useUnicode=true\u0026characterEncoding=utf8\u0026serverTimezone=GMT%2B8\"); ... // 数据库表前缀 strategy.setInclude(new String[]{\"user_t\"}); ... // 生成 Entity、Mapper、XML 的包的相对目录 pc.setEntity(\"com.stylefeng.guns.rest.common.persistence.model\"); pc.setMapper(\"com.stylefeng.guns.rest.common.persistence.dao\"); pc.setXml(\"com.stylefeng.guns.rest.common.persistence.dao.mapping\"); ... 此处生成的实体类属于 guns-user 模块，用于和数据库打交道。以下是 guns-gateway 模块和 guns-user 模块不同的三种 user 类，UserModel 和 UserInfoModel 属于 BO，而 MoocUserT （即UserT） 属于 DO。\n实现相应的接口功能 在 guns-user 模块的 UserServiceImpl 中实现 UserAPI （在 guns-api 中）的接口，如：\n@Component @Service(interfaceClass = UserAPI.class) public class UserServiceImpl implements UserAPI { @Autowired private UserTMapper userTMapper; @Override public boolean register(UserModel userModel) { ... } } 在 guns-gateway 模块的 UserController 中实现编写相应 url 和控制层代码，如：\n@RequestMapping(\"/user/\") @RestController public class UserController { @Reference(interfaceClass = UserAPI.class) private UserAPI userAPI; @RequestMapping(name = \"register\", method = RequestMethod.POST) public ResponseVO register(UserModel userModel) { ... } } Dubbo 特性 存在的问题 必须先启动服务提供者，否则会报错（如下）。如果有两个服务互相依赖，那么两个服务都无法启动成功。（Dubbo 启动检查） Caused by: java.lang.IllegalStateException: Failed to check the status of the service com.stylefeng.guns.api.user.UserAPI. No provider available for the service com.stylefeng.guns.api.user.UserAPI from the url zookeeper://localhost:2181/com.alibaba.dubbo.registry.RegistryService?application=cinema-gateway\u0026dubbo=2.6.0\u0026interface=com.stylefeng.guns.api.user.UserAPI\u0026methods=updateUserInfo,checkUserName,getUserInfo,login,register\u0026pid=10451\u0026register.ip=192.168.6.102\u0026side=consumer\u0026timestamp=1584633672918 to the consumer 192.168.6.102 use dubbo version 2.6.0 如果我们将用户模块部署多台，消费者会如何访问？（Dubbo 负载均衡） spring: dubbo: 中的 protocol 属性是做什么的？（Dubbo 多协议支持） Dubbo 启动检查 官方文档：https://dubbo.apache.org/zh-cn/docs/user/demos/preflight-check.html\n服务启动过程中验证服务提供者的可用性 验证过程出现问题，则阻止整个 Spring 容器初始化 服务启动检查可以尽可能早的发现服务问题 Dubbo 默认打开了启动检查，每个接口的 @Reference 注解都默认 check = true，如果确实想取消启动检查，只需在每个消费者所引用的接口的 @Reference 注解后手动设置 check = false 即可（但是并不推荐）。关闭启动检查后，无论所调用接口的服务有没有启动，都能够正常启动。但如果其调用没有启动的服务，将会报以下错误：\ncom.alibaba.dubbo.rpc.RpcException: No provider available from registry localhost:2181 for service com.stylefeng.guns.api.user.UserAPI on consumer 192.168.6.102 use dubbo version 2.6.0, may be providers disabled or not registered ? Dubbo 负载均衡 官方文档：https://dubbo.apache.org/zh-cn/docs/user/demos/loadbalance.html\n在集群负载均衡时，Dubbo 提供了多种均衡策略，缺省为 random 随机调用。\n负载均衡策略 策略名称 策略描述 Random 随机，按权重设置随机概率 RoundRobin 轮询，按公约后的权重设置轮询比率 LeastActive 最少活跃调用数，相同活跃数的随机，活跃数指调用前后计数差 ConsistentHash 一致性 Hash，相同参数的请求总是发到同一提供者 配置 服务端服务级别 ",
  "wordCount" : "921",
  "inLanguage": "en",
  "datePublished": "2020-03-11T23:45:00Z",
  "dateModified": "2020-03-11T23:45:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://zjxjwxk.github.io/posts/dubbo/dubbo%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BD%B1%E9%99%A2%E7%B3%BB%E5%88%97/5.dubbo%E5%9F%BA%E6%9C%AC%E7%89%B9%E6%80%A7%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Xinkang's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://zjxjwxk.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://zjxjwxk.github.io/" accesskey="h" title="Xinkang&#39;s Blog (Alt + H)">Xinkang&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://zjxjwxk.github.io/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://zjxjwxk.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://zjxjwxk.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://zjxjwxk.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <div id="content-container">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Dubbo微服务影院系列（5）：Dubbo基本特性（用户模块开发）
    </h1>
    <div class="post-meta"><span title='2020-03-11 23:45:00 +0000 UTC'>March 11, 2020</span>

</div>
  </header> 
  <div class="post-content"><h1 id="章节概要">章节概要<a hidden class="anchor" aria-hidden="true" href="#章节概要">#</a></h1>
<ul>
<li>学会 API 网关权限验证和其他服务交互</li>
<li>学会开发 SpringBoot 的自定义配置</li>
<li>学会 Dubbo 负载均衡策略选择和使用</li>
</ul>
<h2 id="修改-guns-中的-jwt-模块">修改 Guns 中的 JWT 模块<a hidden class="anchor" aria-hidden="true" href="#修改-guns-中的-jwt-模块">#</a></h2>
<ul>
<li>增加忽略验证 URL 配置</li>
<li>修改返回内容匹配业务</li>
<li>增加 Threadlocal 的用户信息保存</li>
</ul>
<h2 id="业务功能开发">业务功能开发<a hidden class="anchor" aria-hidden="true" href="#业务功能开发">#</a></h2>
<ul>
<li>增加用户服务并提供接口</li>
<li>初步了解 API 网关与服务之间交互的过程</li>
<li>根据接口文档开发用户接口</li>
</ul>
<h1 id="创建用户表">创建用户表<a hidden class="anchor" aria-hidden="true" href="#创建用户表">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">EXISTS</span> <span style="color:#66d9ef">user</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#66d9ef">user</span>(
</span></span><span style="display:flex;"><span>   UUID INT <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> AUTO_INCREMENT <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;主键编号&#39;</span>,
</span></span><span style="display:flex;"><span>   user_name VARCHAR(<span style="color:#ae81ff">50</span>) <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;用户账号&#39;</span>,
</span></span><span style="display:flex;"><span>   user_pwd VARCHAR(<span style="color:#ae81ff">50</span>) <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;用户密码&#39;</span>,
</span></span><span style="display:flex;"><span>   nick_name VARCHAR(<span style="color:#ae81ff">50</span>) <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;用户昵称&#39;</span>,
</span></span><span style="display:flex;"><span>   user_sex INT <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;用户性别 0-男，1-女&#39;</span>,
</span></span><span style="display:flex;"><span>   birthday VARCHAR(<span style="color:#ae81ff">50</span>) <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;出生日期&#39;</span>,
</span></span><span style="display:flex;"><span>   email VARCHAR(<span style="color:#ae81ff">50</span>) <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;用户邮箱&#39;</span>,
</span></span><span style="display:flex;"><span>   user_phone VARCHAR(<span style="color:#ae81ff">50</span>) <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;用户手机号&#39;</span>,
</span></span><span style="display:flex;"><span>   address VARCHAR(<span style="color:#ae81ff">50</span>) <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;用户住址&#39;</span>,
</span></span><span style="display:flex;"><span>   head_url VARCHAR(<span style="color:#ae81ff">50</span>) <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;头像URL&#39;</span>,
</span></span><span style="display:flex;"><span>   biography VARCHAR(<span style="color:#ae81ff">200</span>) <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;个人介绍&#39;</span>,
</span></span><span style="display:flex;"><span>   life_state INT <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;生活状态 0-单身，1-热恋中，2-已婚，3-为人父母&#39;</span>,
</span></span><span style="display:flex;"><span>   begin_time <span style="color:#66d9ef">TIMESTAMP</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">CURRENT_TIMESTAMP</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;创建时间&#39;</span>,
</span></span><span style="display:flex;"><span>   update_time <span style="color:#66d9ef">TIMESTAMP</span> <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">CURRENT_TIMESTAMP</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">UPDATE</span> <span style="color:#66d9ef">CURRENT_TIMESTAMP</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;修改时间&#39;</span>
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;用户表&#39;</span> ENGINE <span style="color:#f92672">=</span> INNODB AUTO_INCREMENT <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> CHARACTER <span style="color:#66d9ef">SET</span> <span style="color:#f92672">=</span> utf8 <span style="color:#66d9ef">COLLATE</span> <span style="color:#f92672">=</span> utf8_general_ci ROW_FORMAT <span style="color:#f92672">=</span> <span style="color:#66d9ef">DYNAMIC</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#66d9ef">user</span>(user_name,user_pwd,nick_name,user_sex,birthday,email,user_phone,address,head_url,life_state,biography) <span style="color:#66d9ef">values</span>(<span style="color:#e6db74">&#39;admin&#39;</span>,<span style="color:#e6db74">&#39;0192023a7bbd73250516f069df18b500&#39;</span>,<span style="color:#e6db74">&#39;管理员&#39;</span>,<span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#39;2018-07-31&#39;</span>,<span style="color:#e6db74">&#39;admin@gmail.com&#39;</span>,<span style="color:#e6db74">&#39;13888888888&#39;</span>,<span style="color:#e6db74">&#39;浙江省杭州市西湖区某路某号&#39;</span>,<span style="color:#e6db74">&#39;cinema/img/head-img.jpg&#39;</span>,<span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#39;我是苦逼的管理员&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#66d9ef">user</span>(user_name,user_pwd,nick_name,user_sex,birthday,email,user_phone,address,head_url,life_state,biography) <span style="color:#66d9ef">values</span>(<span style="color:#e6db74">&#39;test&#39;</span>,<span style="color:#e6db74">&#39;5e2de6bd1c9b50f6e27d4e55da43b917&#39;</span>,<span style="color:#e6db74">&#39;测试用户&#39;</span>,<span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#39;2018-08-20&#39;</span>,<span style="color:#e6db74">&#39;test@gmail.com&#39;</span>,<span style="color:#e6db74">&#39;13866666666&#39;</span>,<span style="color:#e6db74">&#39;测试地址&#39;</span>,<span style="color:#e6db74">&#39;cinema/img/head-img.jpg&#39;</span>,<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;我是测试用户&#39;</span>);
</span></span></code></pre></div><h1 id="用户服务与网关交互">用户服务与网关交互<a hidden class="anchor" aria-hidden="true" href="#用户服务与网关交互">#</a></h1>
<p>在 guns 项目中复制一份 guns-gateway 模块并重命名为 guns-user（修改相应子模块和主模块的 pom.xml 等），并在 application.yml 中将其鉴权机制等关闭（网关才需要）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">rest</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">auth-open</span>: <span style="color:#66d9ef">false</span> <span style="color:#75715e">#jwt鉴权机制是否开启(true或者false)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sign-open</span>: <span style="color:#66d9ef">false</span> <span style="color:#75715e">#签名机制是否开启(true或false)</span>
</span></span></code></pre></div><p>端口设为8083</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">server</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8083</span> <span style="color:#75715e">#项目端口</span>
</span></span></code></pre></div><p>在 spring:dubbo: 下添加 Dubbo 协议和端口（UserApplication 需要向外部暴露接口，先向注册中心注册，然后通过 Dubbo 协议被远程调用）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">application</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cinema-user</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dubbo</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">registry</span>: <span style="color:#ae81ff">zookeeper://localhost:2181</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dubbo</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">20881</span>
</span></span></code></pre></div><p>在 guns-user 中编写 UserAPI 的实现类，其中 UserAPI 接口是来自于 guns-api 的（在前一章已经做了业务 API 抽离），并通过 @Service 向外部暴露</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>(interfaceClass <span style="color:#f92672">=</span> UserAPI.<span style="color:#a6e22e">class</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserImpl</span> <span style="color:#66d9ef">implements</span> UserAPI {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">login</span>(String username, String password) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;This is user service! &#34;</span> <span style="color:#f92672">+</span> username <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, &#34;</span> <span style="color:#f92672">+</span> password);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后，在 guns-gateway 中就可以远程调用 UserAPI 接口了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#a6e22e">@Reference</span>(interfaceClass <span style="color:#f92672">=</span> UserAPI.<span style="color:#a6e22e">class</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> UserAPI userAPI;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    userAPI.<span style="color:#a6e22e">login</span>(username, password);
</span></span></code></pre></div><h1 id="基于-springboot-配置忽略列表">基于 SpringBoot 配置忽略列表<a hidden class="anchor" aria-hidden="true" href="#基于-springboot-配置忽略列表">#</a></h1>
<p>配置 guns-gateway 网关模块中的 application.yml，在 jwt 下添加 ignore-url 配置，用逗号分隔 url（<strong>注意不能有空格！</strong>），这些接口将不通过 jwt 验证过滤器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">jwt</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">header</span>: <span style="color:#ae81ff">Authorization  </span> <span style="color:#75715e">#http请求头所需要的字段</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">secret</span>: <span style="color:#ae81ff">mySecret       </span> <span style="color:#75715e">#jwt秘钥</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">expiration</span>: <span style="color:#ae81ff">604800</span>      <span style="color:#75715e">#7天 单位:秒</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">auth-path</span>: <span style="color:#ae81ff">auth        </span> <span style="color:#75715e">#认证请求的路径</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">md5-key</span>: <span style="color:#ae81ff">randomKey     </span> <span style="color:#75715e">#md5加密混淆key</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ignore-url</span>: <span style="color:#ae81ff">/user/,/film/ </span> <span style="color:#75715e">#忽略列表</span>
</span></span></code></pre></div><p>在 JwtProperties 中添加一项成员变量，并添加 get、set 函数，这个类是配置类，<code>@ConfigurationProperties(prefix = JwtProperties.JWT_PREFIX)</code> 表示用于从配置文件 application.yml 中获取 jwt 开头的配置变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConfigurationProperties</span>(prefix <span style="color:#f92672">=</span> JwtProperties.<span style="color:#a6e22e">JWT_PREFIX</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JwtProperties</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String JWT_PREFIX <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jwt&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String header <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Authorization&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;defaultSecret&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Long expiration <span style="color:#f92672">=</span> 604800L;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String authPath <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;auth&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String md5Key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;randomKey&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String ignoreUrl <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span></code></pre></div><p>在 AuthFilter 的 doFilterInternal 方法中添加以下代码，用于忽略配置列表</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#75715e">// 配置忽略列表</span>
</span></span><span style="display:flex;"><span>        String ignoreUrl <span style="color:#f92672">=</span> jwtProperties.<span style="color:#a6e22e">getIgnoreUrl</span>();
</span></span><span style="display:flex;"><span>        String<span style="color:#f92672">[]</span> ignoreUrls <span style="color:#f92672">=</span> ignoreUrl.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;,&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0; i <span style="color:#f92672">&lt;</span> ignoreUrls.<span style="color:#a6e22e">length</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (request.<span style="color:#a6e22e">getServletPath</span>().<span style="color:#a6e22e">equals</span>(ignoreUrls<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>)) {
</span></span><span style="display:flex;"><span>                chain.<span style="color:#a6e22e">doFilter</span>(request, response);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><h1 id="修改-jwt-申请的返回报文">修改 JWT 申请的返回报文<a hidden class="anchor" aria-hidden="true" href="#修改-jwt-申请的返回报文">#</a></h1>
<p>在 guns-gateway 模块中的 modular.vo 下，创建 ResponseVO 类作为响应VO类，其中包含了三种状态 Status ：0-成功，1-业务失败，999-系统异常</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ResponseVO</span><span style="color:#f92672">&lt;</span>M<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 返回状态 [0-成功，1-业务失败，999-系统异常]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Integer status;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 返回信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String msg;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 返回数据实体
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> M data;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">ResponseVO</span>() {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span><span style="color:#f92672">&lt;</span>M<span style="color:#f92672">&gt;</span> ResponseVO <span style="color:#a6e22e">success</span>(M m) {
</span></span><span style="display:flex;"><span>        ResponseVO responseVO <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ResponseVO();
</span></span><span style="display:flex;"><span>        responseVO.<span style="color:#a6e22e">setStatus</span>(0);
</span></span><span style="display:flex;"><span>        responseVO.<span style="color:#a6e22e">setData</span>(m);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> responseVO;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ResponseVO <span style="color:#a6e22e">serviceFail</span>(String msg) {
</span></span><span style="display:flex;"><span>        ResponseVO responseVO <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ResponseVO();
</span></span><span style="display:flex;"><span>        responseVO.<span style="color:#a6e22e">setStatus</span>(1);
</span></span><span style="display:flex;"><span>        responseVO.<span style="color:#a6e22e">setMsg</span>(msg);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> responseVO;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ResponseVO <span style="color:#a6e22e">appFail</span>(String msg) {
</span></span><span style="display:flex;"><span>        ResponseVO responseVO <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ResponseVO();
</span></span><span style="display:flex;"><span>        responseVO.<span style="color:#a6e22e">setStatus</span>(999);
</span></span><span style="display:flex;"><span>        responseVO.<span style="color:#a6e22e">setMsg</span>(msg);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> responseVO;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>之后在 AuthController 中就可以用该类作为返回对象了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#a6e22e">@RequestMapping</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${jwt.auth-path}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ResponseVO <span style="color:#a6e22e">createAuthenticationToken</span>(AuthRequest authRequest) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> validate <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 去掉guns自身携带的用户名密码验证机制，使用自己的</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> userId <span style="color:#f92672">=</span> userAPI.<span style="color:#a6e22e">login</span>(authRequest.<span style="color:#a6e22e">getUserName</span>(), authRequest.<span style="color:#a6e22e">getPassword</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (userId <span style="color:#f92672">==</span> 0) {
</span></span><span style="display:flex;"><span>            validate <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (validate) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// randomKey和token已经生成完毕</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">final</span> String randomKey <span style="color:#f92672">=</span> jwtTokenUtil.<span style="color:#a6e22e">getRandomKey</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">final</span> String token <span style="color:#f92672">=</span> jwtTokenUtil.<span style="color:#a6e22e">generateToken</span>(<span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">+</span> userId, randomKey);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 返回值</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ResponseVO.<span style="color:#a6e22e">success</span>(<span style="color:#66d9ef">new</span> AuthResponse(token, randomKey));
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ResponseVO.<span style="color:#a6e22e">serviceFail</span>(<span style="color:#e6db74">&#34;用户名或密码错误&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h1 id="增加-threadlocal-的用户信息保存">增加 Threadlocal 的用户信息保存<a hidden class="anchor" aria-hidden="true" href="#增加-threadlocal-的用户信息保存">#</a></h1>
<p>在 guns-gateway 中的 common 下创建 CurrentUser 类用于保存 userId（不直接保存 userInfoModel 是因为更省空间，避免用户量大时出现内存溢出），该 userId 存在 ThreadLocal 中和线程绑定，同一线程内共享</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CurrentUser</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 线程绑定的存储空间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ThreadLocal<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> threadLocal <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocal<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">saveUserId</span>(String userId) {
</span></span><span style="display:flex;"><span>        threadLocal.<span style="color:#a6e22e">set</span>(userId);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">getCurrentUser</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> threadLocal.<span style="color:#a6e22e">get</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>之后，在 AuthFilter 验证 token 时，就可以通过 token 获取 userID，并且将之存入 ThreadLocal，以便后续业务调用了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>            String userId <span style="color:#f92672">=</span> jwtTokenUtil.<span style="color:#a6e22e">getUsernameFromToken</span>(authToken);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (userId <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                CurrentUser.<span style="color:#a6e22e">saveUserId</span>(userId);
</span></span><span style="display:flex;"><span>            }
</span></span></code></pre></div><p>在用户后续访问时，就可以取出 userId，并从数据库或 redis 中获取用户信息了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Controller</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span>(<span style="color:#e6db74">&#34;/hello&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExampleController</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@RequestMapping</span>(<span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ResponseEntity <span style="color:#a6e22e">hello</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(CurrentUser.<span style="color:#a6e22e">getCurrentUser</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 这里将以userId为key，userInfo为value存在redis中，TTL为30分钟</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 或以userId为条件去数据库取出（和redis只有快慢的区别）</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ResponseEntity.<span style="color:#a6e22e">ok</span>(<span style="color:#e6db74">&#34;请求成功!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="用户模块开发">用户模块开发<a hidden class="anchor" aria-hidden="true" href="#用户模块开发">#</a></h1>
<h2 id="业务功能开发流程">业务功能开发流程<a hidden class="anchor" aria-hidden="true" href="#业务功能开发流程">#</a></h2>
<h3 id="使用代码生成器生成数据项">使用代码生成器生成数据项<a hidden class="anchor" aria-hidden="true" href="#使用代码生成器生成数据项">#</a></h3>
<p>在每个 guns 模块的 test 下，都有 enerator.EntityGenerator 这个用于实体生成的类，只需根据需要稍微修改一下方法的参数即可。在 guns-user 模块中生成即可得到：UserT, UserTMapper, UserTMapper.xml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 生成代码的绝对目录</span>
</span></span><span style="display:flex;"><span>gc.<span style="color:#a6e22e">setOutputDir</span>(<span style="color:#e6db74">&#34;/Users/zjxjwxk/Documents/GitHub/Cinema-Dubbo/guns-user/src/main/java&#34;</span>);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 作者信息</span>
</span></span><span style="display:flex;"><span>gc.<span style="color:#a6e22e">setAuthor</span>(<span style="color:#e6db74">&#34;zjxjwxk&#34;</span>);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 数据库连接配置</span>
</span></span><span style="display:flex;"><span>dsc.<span style="color:#a6e22e">setUsername</span>(<span style="color:#e6db74">&#34;root&#34;</span>);
</span></span><span style="display:flex;"><span>dsc.<span style="color:#a6e22e">setPassword</span>(<span style="color:#e6db74">&#34;19981018&#34;</span>);
</span></span><span style="display:flex;"><span>dsc.<span style="color:#a6e22e">setUrl</span>(<span style="color:#e6db74">&#34;jdbc:mysql://127.0.0.1:3306/guns_rest?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8&#34;</span>);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 数据库表前缀</span>
</span></span><span style="display:flex;"><span>strategy.<span style="color:#a6e22e">setInclude</span>(<span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;user_t&#34;</span>});
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 生成 Entity、Mapper、XML 的包的相对目录</span>
</span></span><span style="display:flex;"><span>pc.<span style="color:#a6e22e">setEntity</span>(<span style="color:#e6db74">&#34;com.stylefeng.guns.rest.common.persistence.model&#34;</span>);
</span></span><span style="display:flex;"><span>pc.<span style="color:#a6e22e">setMapper</span>(<span style="color:#e6db74">&#34;com.stylefeng.guns.rest.common.persistence.dao&#34;</span>);
</span></span><span style="display:flex;"><span>pc.<span style="color:#a6e22e">setXml</span>(<span style="color:#e6db74">&#34;com.stylefeng.guns.rest.common.persistence.dao.mapping&#34;</span>);
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>此处生成的实体类属于 guns-user 模块，用于和数据库打交道。以下是 guns-gateway 模块和 guns-user 模块不同的三种 user 类，UserModel 和 UserInfoModel 属于 BO，而 MoocUserT （即UserT） 属于 DO。</p>
<p><img alt="不同模块中的User类" loading="lazy" src="/posts/dubbo/dubbo%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BD%B1%E9%99%A2%E7%B3%BB%E5%88%97/5.dubbo%E5%9F%BA%E6%9C%AC%E7%89%B9%E6%80%A7%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/images/image-20200317202533906.png"></p>
<h3 id="实现相应的接口功能">实现相应的接口功能<a hidden class="anchor" aria-hidden="true" href="#实现相应的接口功能">#</a></h3>
<p>在 guns-user 模块的 UserServiceImpl 中实现 UserAPI （在 guns-api 中）的接口，如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>(interfaceClass <span style="color:#f92672">=</span> UserAPI.<span style="color:#a6e22e">class</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserServiceImpl</span> <span style="color:#66d9ef">implements</span> UserAPI {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> UserTMapper userTMapper;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">register</span>(UserModel userModel)  {
</span></span><span style="display:flex;"><span>		...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在 guns-gateway 模块的 UserController 中实现编写相应 url 和控制层代码，如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span>(<span style="color:#e6db74">&#34;/user/&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserController</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Reference</span>(interfaceClass <span style="color:#f92672">=</span> UserAPI.<span style="color:#a6e22e">class</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> UserAPI userAPI;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@RequestMapping</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;register&#34;</span>, method <span style="color:#f92672">=</span> RequestMethod.<span style="color:#a6e22e">POST</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ResponseVO <span style="color:#a6e22e">register</span>(UserModel userModel) {
</span></span><span style="display:flex;"><span>       ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="dubbo-特性">Dubbo 特性<a hidden class="anchor" aria-hidden="true" href="#dubbo-特性">#</a></h1>
<h2 id="存在的问题">存在的问题<a hidden class="anchor" aria-hidden="true" href="#存在的问题">#</a></h2>
<ul>
<li>必须先启动服务提供者，否则会报错（如下）。如果有两个服务互相依赖，那么两个服务都无法启动成功。（Dubbo 启动检查）</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Caused by: java.lang.IllegalStateException: Failed to check the status of the service com.stylefeng.guns.api.user.UserAPI. No provider available for the service com.stylefeng.guns.api.user.UserAPI from the url zookeeper://localhost:2181/com.alibaba.dubbo.registry.RegistryService?application=cinema-gateway&amp;dubbo=2.6.0&amp;interface=com.stylefeng.guns.api.user.UserAPI&amp;methods=updateUserInfo,checkUserName,getUserInfo,login,register&amp;pid=10451&amp;register.ip=192.168.6.102&amp;side=consumer&amp;timestamp=1584633672918 to the consumer 192.168.6.102 use dubbo version 2.6.0
</span></span></code></pre></div><ul>
<li>如果我们将用户模块部署多台，消费者会如何访问？（Dubbo 负载均衡）</li>
<li>spring: dubbo: 中的 protocol 属性是做什么的？（Dubbo 多协议支持）</li>
</ul>
<h2 id="dubbo-启动检查">Dubbo 启动检查<a hidden class="anchor" aria-hidden="true" href="#dubbo-启动检查">#</a></h2>
<blockquote>
<p>官方文档：https://dubbo.apache.org/zh-cn/docs/user/demos/preflight-check.html</p>
</blockquote>
<ul>
<li>服务启动过程中验证服务提供者的可用性</li>
<li>验证过程出现问题，则阻止整个 Spring 容器初始化</li>
<li>服务启动检查可以尽可能早的发现服务问题</li>
</ul>
<p>Dubbo 默认打开了启动检查，每个接口的 @Reference 注解都默认 check = true，如果确实想取消启动检查，只需在每个消费者所引用的接口的 @Reference 注解后手动设置 check = false 即可（但是并不推荐）。关闭启动检查后，无论所调用接口的服务有没有启动，都能够正常启动。但如果其调用没有启动的服务，将会报以下错误：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>com.alibaba.dubbo.rpc.RpcException: No provider available from registry localhost:2181 for service com.stylefeng.guns.api.user.UserAPI on consumer 192.168.6.102 use dubbo version 2.6.0, may be providers disabled or not registered ?
</span></span></code></pre></div><h2 id="dubbo-负载均衡">Dubbo 负载均衡<a hidden class="anchor" aria-hidden="true" href="#dubbo-负载均衡">#</a></h2>
<blockquote>
<p>官方文档：https://dubbo.apache.org/zh-cn/docs/user/demos/loadbalance.html</p>
</blockquote>
<p>在集群负载均衡时，Dubbo 提供了多种均衡策略，缺省为 <code>random</code> 随机调用。</p>
<h3 id="负载均衡策略">负载均衡策略<a hidden class="anchor" aria-hidden="true" href="#负载均衡策略">#</a></h3>
<table>
  <thead>
      <tr>
          <th>策略名称</th>
          <th>策略描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Random</td>
          <td><strong>随机</strong>，按权重设置随机概率</td>
      </tr>
      <tr>
          <td>RoundRobin</td>
          <td><strong>轮询</strong>，按公约后的权重设置轮询比率</td>
      </tr>
      <tr>
          <td>LeastActive</td>
          <td><strong>最少活跃调用数</strong>，相同活跃数的随机，活跃数指调用前后计数差</td>
      </tr>
      <tr>
          <td>ConsistentHash</td>
          <td><strong>一致性 Hash</strong>，相同参数的请求总是发到同一提供者</td>
      </tr>
  </tbody>
</table>
<h3 id="配置">配置<a hidden class="anchor" aria-hidden="true" href="#配置">#</a></h3>
<h4 id="服务端服务级别">服务端服务级别<a hidden class="anchor" aria-hidden="true" href="#服务端服务级别">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dubbo:service</span> <span style="color:#a6e22e">interface=</span><span style="color:#e6db74">&#34;...&#34;</span>  <span style="color:#a6e22e">loadbalance=</span><span style="color:#e6db74">&#34;roundrobin&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span></code></pre></div><h4 id="客户端服务级别">客户端服务级别<a hidden class="anchor" aria-hidden="true" href="#客户端服务级别">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dubbo:reference</span> <span style="color:#a6e22e">interface=</span><span style="color:#e6db74">&#34;...&#34;</span> <span style="color:#a6e22e">loadbalance=</span><span style="color:#e6db74">&#34;roundrobin&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span></code></pre></div><h4 id="服务端方法级别">服务端方法级别<a hidden class="anchor" aria-hidden="true" href="#服务端方法级别">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dubbo:service</span> <span style="color:#a6e22e">interface=</span><span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dubbo:method</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;...&#34;</span> <span style="color:#a6e22e">loadbalance=</span><span style="color:#e6db74">&#34;roundrobin&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dubbo:service&gt;</span>
</span></span></code></pre></div><h4 id="客户端方法级别">客户端方法级别<a hidden class="anchor" aria-hidden="true" href="#客户端方法级别">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dubbo:reference</span> <span style="color:#a6e22e">interface=</span><span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dubbo:method</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;...&#34;</span> <span style="color:#a6e22e">loadbalance=</span><span style="color:#e6db74">&#34;roundrobin&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dubbo:reference&gt;</span>
</span></span></code></pre></div><h2 id="dubbo-多协议支持">Dubbo 多协议支持<a hidden class="anchor" aria-hidden="true" href="#dubbo-多协议支持">#</a></h2>
<blockquote>
<p>官方文档：https://dubbo.apache.org/zh-cn/docs/user/demos/multi-protocols.html</p>
</blockquote>
<h3 id="多协议支撑">多协议支撑<a hidden class="anchor" aria-hidden="true" href="#多协议支撑">#</a></h3>
<ul>
<li>Dubbo 支持多种协议</li>
<li>最常见的协议是 dubbo</li>
<li>RMI、Hessian、HTTP、Redis、Memcached 等多种协议</li>
</ul>
<h3 id="协议对比">协议对比<a hidden class="anchor" aria-hidden="true" href="#协议对比">#</a></h3>
<table>
  <thead>
      <tr>
          <th>特性对比</th>
          <th>dubbo</th>
          <th>RMI</th>
          <th>Hessian</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>连接数</td>
          <td>单连接</td>
          <td>多连接</td>
          <td>多连接</td>
      </tr>
      <tr>
          <td>连接方式</td>
          <td>长连接</td>
          <td>短连接</td>
          <td>短连接</td>
      </tr>
      <tr>
          <td>传输协议</td>
          <td>TCP 传输</td>
          <td>同步传输</td>
          <td>同步传输</td>
      </tr>
      <tr>
          <td>传输方式</td>
          <td>NIO 异步传输</td>
          <td>同步传输</td>
          <td>同步传输</td>
      </tr>
      <tr>
          <td>适用场景</td>
          <td>1. 数据包较小<!-- raw HTML omitted -->2. 消费者个数多<!-- raw HTML omitted -->3. 常规方式</td>
          <td>1. 数据包大小不一<!-- raw HTML omitted -->2. 消费者和提供者数量相差不大</td>
          <td>1. 数据包大小不一<!-- raw HTML omitted -->2. 消费者和提供者数量相差不大</td>
      </tr>
  </tbody>
</table>
<h1 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h1>
<ul>
<li>API 网关与服务模块调用方式（API 网关相当于服务消费者，服务模块相当于服务提供者）</li>
<li>Dubbo 特性：负载均衡、启动检查、Dubbo 协议</li>
<li>JWT 的业务应用</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://zjxjwxk.github.io/tags/dubbo/">Dubbo</a></li>
      <li><a href="https://zjxjwxk.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84/">微服务架构</a></li>
    </ul>
  </footer>
</article>

<script>
  window.onload = function() {
      var contentContainer = document.getElementById("content-container");
      if ("" !== "") {
          var password = prompt("Enter password:");
          if (password === "") {
              contentContainer.style.display = "block";
          } else {
              alert("Incorrect password");
          }
      } else {
          contentContainer.style.display = "block";
      }
  };
</script>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://zjxjwxk.github.io/">Xinkang&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
