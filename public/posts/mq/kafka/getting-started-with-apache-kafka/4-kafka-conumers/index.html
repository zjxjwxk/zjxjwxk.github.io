<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Kafka Consumer | Xinkang&#39;s Blog</title>
<meta name="keywords" content="MQ, Kafka">
<meta name="description" content="Kafka Consumer Group

Consumers are typically done as a group.
A single consumer will end up inefficient with large amounts of data.
A consumer may never catch up.
Every consumer should be on it&rsquo;s own machine, instance, pod.

The consumer group ID is the key so Kafka knows that messages should be distributed to both consumers without duplicating.

If we add one more consumer to this group, the last one will be idle, because one partition can&rsquo;t be share across consumers. One partition can only be assigned to one consumer. Instead, the partitions are the way of Kafka to scale. More partitions imply you can have more consumers in the same consumer group.">
<meta name="author" content="">
<link rel="canonical" href="https://zjxjwxk.github.io/posts/mq/kafka/getting-started-with-apache-kafka/4-kafka-conumers/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://zjxjwxk.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://zjxjwxk.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://zjxjwxk.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://zjxjwxk.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://zjxjwxk.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://zjxjwxk.github.io/posts/mq/kafka/getting-started-with-apache-kafka/4-kafka-conumers/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-9CMXGMMTKX"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-9CMXGMMTKX');
        }
      </script><meta property="og:url" content="https://zjxjwxk.github.io/posts/mq/kafka/getting-started-with-apache-kafka/4-kafka-conumers/">
  <meta property="og:site_name" content="Xinkang&#39;s Blog">
  <meta property="og:title" content="Kafka Consumer">
  <meta property="og:description" content="Kafka Consumer Group Consumers are typically done as a group. A single consumer will end up inefficient with large amounts of data. A consumer may never catch up. Every consumer should be on it’s own machine, instance, pod. The consumer group ID is the key so Kafka knows that messages should be distributed to both consumers without duplicating.
If we add one more consumer to this group, the last one will be idle, because one partition can’t be share across consumers. One partition can only be assigned to one consumer. Instead, the partitions are the way of Kafka to scale. More partitions imply you can have more consumers in the same consumer group.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-11-18T18:41:00+08:00">
    <meta property="article:modified_time" content="2024-11-18T18:41:00+08:00">
    <meta property="article:tag" content="MQ">
    <meta property="article:tag" content="Kafka">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kafka Consumer">
<meta name="twitter:description" content="Kafka Consumer Group

Consumers are typically done as a group.
A single consumer will end up inefficient with large amounts of data.
A consumer may never catch up.
Every consumer should be on it&rsquo;s own machine, instance, pod.

The consumer group ID is the key so Kafka knows that messages should be distributed to both consumers without duplicating.

If we add one more consumer to this group, the last one will be idle, because one partition can&rsquo;t be share across consumers. One partition can only be assigned to one consumer. Instead, the partitions are the way of Kafka to scale. More partitions imply you can have more consumers in the same consumer group.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://zjxjwxk.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Kafka Consumer",
      "item": "https://zjxjwxk.github.io/posts/mq/kafka/getting-started-with-apache-kafka/4-kafka-conumers/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kafka Consumer",
  "name": "Kafka Consumer",
  "description": "Kafka Consumer Group Consumers are typically done as a group. A single consumer will end up inefficient with large amounts of data. A consumer may never catch up. Every consumer should be on it\u0026rsquo;s own machine, instance, pod. The consumer group ID is the key so Kafka knows that messages should be distributed to both consumers without duplicating.\nIf we add one more consumer to this group, the last one will be idle, because one partition can\u0026rsquo;t be share across consumers. One partition can only be assigned to one consumer. Instead, the partitions are the way of Kafka to scale. More partitions imply you can have more consumers in the same consumer group.\n",
  "keywords": [
    "MQ", "Kafka"
  ],
  "articleBody": "Kafka Consumer Group Consumers are typically done as a group. A single consumer will end up inefficient with large amounts of data. A consumer may never catch up. Every consumer should be on it’s own machine, instance, pod. The consumer group ID is the key so Kafka knows that messages should be distributed to both consumers without duplicating.\nIf we add one more consumer to this group, the last one will be idle, because one partition can’t be share across consumers. One partition can only be assigned to one consumer. Instead, the partitions are the way of Kafka to scale. More partitions imply you can have more consumers in the same consumer group.\nDemo: Consuming from Kafka Run Kafka Containers Create a docker-compose file docker-compose.yaml containing three Zookeepers, three Kafka Brokers, and a Kafka REST Proxy:\n--- version: '3' services: zookeeper-1: image: confluentinc/cp-zookeeper:7.4.1 hostname: zookeeper-1 container_name: zookeeper-1 volumes: - ./zookeeper-1_data:/var/lib/zookeeper/data - ./zookeeper-1_log:/var/lib/zookeeper/log environment: ZOOKEEPER_CLIENT_PORT: 2181 ZOOKEEPER_TICK_TIME: 2000 ZOO_MY_ID: 1 ZOO_SERVERS: server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181 zookeeper-2: image: confluentinc/cp-zookeeper:7.4.1 hostname: zookeeper-2 container_name: zookeeper-2 volumes: - ./zookeeper-2_data:/var/lib/zookeeper/data - ./zookeeper-2_log:/var/lib/zookeeper/log environment: ZOOKEEPER_CLIENT_PORT: 2181 ZOOKEEPER_TICK_TIME: 2000 ZOO_MY_ID: 2 ZOO_SERVERS: server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181 zookeeper-3: image: confluentinc/cp-zookeeper:7.4.1 hostname: zookeeper-3 container_name: zookeeper-3 volumes: - ./zookeeper-3_data:/var/lib/zookeeper/data - ./zookeeper-3_log:/var/lib/zookeeper/log environment: ZOOKEEPER_CLIENT_PORT: 2181 ZOOKEEPER_TICK_TIME: 2000 ZOO_MY_ID: 3 ZOO_SERVERS: server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181 broker-1: image: confluentinc/cp-kafka:7.4.1 hostname: broker-1 container_name: broker-1 volumes: - ./broker-1-data:/var/lib/kafka/data depends_on: - zookeeper-1 - zookeeper-2 - zookeeper-3 ports: - 9092:9092 - 29092:29092 environment: KAFKA_BROKER_ID: 1 KAFKA_ZOOKEEPER_CONNECT: zookeeper-1:2181 KAFKA_ADVERTISED_LISTENERS: HOST://localhost:9092,INTERNAL://broker-1:29092 KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: HOST:PLAINTEXT,INTERNAL:PLAINTEXT KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL KAFKA_SNAPSHOT_TRUST_EMPTY: true broker-2: image: confluentinc/cp-kafka:7.4.1 hostname: broker-2 container_name: broker-2 volumes: - ./broker-2-data:/var/lib/kafka/data depends_on: - zookeeper-1 - zookeeper-2 - zookeeper-3 - broker-1 ports: - 9093:9093 - 29093:29093 environment: KAFKA_BROKER_ID: 2 KAFKA_ZOOKEEPER_CONNECT: zookeeper-1:2181 KAFKA_ADVERTISED_LISTENERS: HOST://localhost:9093,INTERNAL://broker-2:29093 KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: HOST:PLAINTEXT,INTERNAL:PLAINTEXT KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL KAFKA_SNAPSHOT_TRUST_EMPTY: true broker-3: image: confluentinc/cp-kafka:7.4.1 hostname: broker-3 container_name: broker-3 volumes: - ./broker-3-data:/var/lib/kafka/data depends_on: - zookeeper-1 - zookeeper-2 - zookeeper-3 - broker-1 - broker-2 ports: - 9094:9094 - 29094:29094 environment: KAFKA_BROKER_ID: 3 KAFKA_ZOOKEEPER_CONNECT: zookeeper-1:2181 KAFKA_ADVERTISED_LISTENERS: HOST://localhost:9094,INTERNAL://broker-3:29094 KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: HOST:PLAINTEXT,INTERNAL:PLAINTEXT KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL KAFKA_SNAPSHOT_TRUST_EMPTY: true rest-proxy: image: confluentinc/cp-kafka-rest:7.4.1 ports: - \"8082:8082\" depends_on: - zookeeper-1 - zookeeper-2 - zookeeper-3 - broker-1 - broker-2 - broker-3 hostname: rest-proxy container_name: rest-proxy environment: KAFKA_REST_HOST_NAME: rest-proxy KAFKA_REST_BOOTSTRAP_SERVERS: 'broker-1:29092,broker-2:29093,broker-3:29094' KAFKA_REST_LISTENERS: \"http://0.0.0.0:8082\" Run composed containers:\ndocker compose up -d Create Topic Create a topic myorders with 2 partitions:\nkafka-topics.sh --create --bootstrap-server localhost:9092 --partitions 2 --topic myorders Run Consumer Run 3 Kafka Consumers in different terminals lisitening to the same topic myorders and deserialize the messages by string key and double value seperated by ,:\nkafka-console-consumer.sh \\ --bootstrap-server localhost:9092 \\ --topic myorders --from-beginning \\ --key-deserializer org.apache.kafka.common.serialization.StringDeserializer \\ --value-deserializer org.apache.kafka.common.serialization.DoubleDeserializer \\ --property print.key=true \\ --property key.separator=, \\ --group 1 Then, in another terminal, run another consumer with all the other same parameters but with --group 2.\nWe can see check the logs of broker 1:\ndocker logs broker-1 The following log can be found, which means there are three members in the group 1:\n[2024-11-18 14:36:14,337] INFO [GroupCoordinator 1]: Stabilized group 1 generation 3 (__consumer_offsets-49) with 3 members (kafka.coordinator.group.GroupCoordinator) [2024-11-18 14:36:14,346] INFO [GroupCoordinator 1]: Assignment received from leader console-consumer-340e7131-cbd4-4811-a62a-543fbac93948 for group 1 for generation 3. The group has 3 members, 0 of which are static. (kafka.coordinator.group.GroupCoordinator) And in the logs of broker 2 (or 3), we can see that there is one consumer in the group 2:\n[2024-11-18 14:38:49,987] INFO [GroupCoordinator 3]: Stabilized group 2 generation 1 (__consumer_offsets-0) with 1 members (kafka.coordinator.group.GroupCoordinator) [2024-11-18 14:38:50,050] INFO [GroupCoordinator 3]: Assignment received from leader console-consumer-bebf5e94-8479-4ab8-b078-ced3f0d81d4c for group 2 for generation 1. The group has 1 members, 0 of which are static. (kafka.coordinator.group.GroupCoordinator) Send Messages Run the following Java method to send messages to the topic myorders:\npublic class Main { private static final Logger log = LoggerFactory.getLogger(Main.class); private static final String TOPIC = \"myorders\"; public static void main(String[] args) throws InterruptedException { Properties props = new Properties(); props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, \"http://localhost:9092,http://localhost:9093,http://localhost:9094\"); props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName()); props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, DoubleSerializer.class.getName()); KafkaProducer\u003cString, Double\u003e producer = new KafkaProducer\u003c\u003e(props); String stateString = \"AK,AL,AZ,AR,CA,CO,CT,DE,FL,GA,\" + \"HI,ID,IL,IN,IA,KS,KY,LA,ME, MD,\" + \"MA,MI,MN,MS,MO,MT,NE,NV,NH,NJ,\" + \"NM,NY,NC,ND,OH,OK,OR,PA,RI,SC,\" + \"SD,TN,TX,UT,VT,VA,WA,WV,WI,WY\"; String[] stateArray = stateString.split(\",\"); for (int i = 0; i \u003c 25000; i++) { String key = stateArray[(int) Math.floor(Math.random()*(50))]; double value = Math.floor(Math.random()* (10000-10+1)+10); ProducerRecord\u003cString, Double\u003e producerRecord = new ProducerRecord\u003c\u003e(TOPIC, key, value); log.info(\"Sending message with key \" + key + \" to Kafka\"); producer.send(producerRecord, (metadata, e) -\u003e { if (metadata != null) { System.out.println(producerRecord.key()); System.out.println(producerRecord.value()); System.out.println(metadata.toString()); } }); Thread.sleep(5000); } producer.flush(); producer.close(); log.info(\"Successfully produced messages to \" + TOPIC + \" topic\"); } } We can see that the consumer in the group 2 read all messages:\nMT,4138.0 LA,6868.0 KS,6318.0 MA,6184.0 NM,8817.0 NJ,6606.0 NV,9748.0 The consumer 1 in the group 1:\nMT,4138.0 NV,9748.0 The consumer 2 (or 3) in the group 2:\nLA,6868.0 KS,6318.0 MA,6184.0 NM,8817.0 NJ,6606.0 But consumer 3 (or 2) in the group 3 doesn’t read any message. That’s because there are only two partitions, which has been assigned to the other two consumers. So this consumer is idle. One partition can only be assigned to one consumer.\nWe can chek the detail of consumer groups:\n❯ kafka-consumer-groups.sh --all-groups --all-topics --bootstrap-server localhost:9092 --describe GROUP TOPIC PARTITION CURRENT-OFFSET LOG-END-OFFSET LAG CONSUMER-ID HOST CLIENT-ID 1 myorders 0 13 13 0 console-consumer-340e7131-cbd4-4811-a62a-543fbac93948 /172.18.0.1 console-consumer 1 myorders 1 16 16 0 console-consumer-68f58739-69be-4f48-af94-590ee15add84 /172.18.0.1 console-consumer GROUP TOPIC PARTITION CURRENT-OFFSET LOG-END-OFFSET LAG CONSUMER-ID HOST CLIENT-ID 2 myorders 1 16 16 0 console-consumer-bebf5e94-8479-4ab8-b078-ced3f0d81d4c /172.18.0.1 console-consumer 2 myorders 0 13 13 0 console-consumer-bebf5e94-8479-4ab8-b078-ced3f0d81d4c /172.18.0.1 console-consumer% We can see that in the group 1, these two partitions are assigned to two different consumers. But in the group2, these two partitions are assigned to the same consumer.\nDemo: Consuming Messages with Java Deserializers and Consumer Configuration Provide two or more locations where the Bootstrap servers are located:\nProperties properties = new Properties(); properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, \"localhost:9092\"); properties.put(ConsumerConfig.GROUP_ID_CONFIG, \"my_group\"); properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, \"org.apache.kafka.common.serialization.StringDeserializer\"); properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, \"org.apache.kafka,common,serialization.IntegerDeserializer\"); properties.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, \"earliest\"); Construct a org.apache.kafka.clients.consumer.KafkaConsumer object:\nKafkaConsumer consumer = new KafkaConsumer\u003c\u003e(properties); Use the consumer that you have constructed, and call poll with pulse time:\nwhile (!done.get()) { ConsumerRecords\u003cString, String\u003e records = consumer.poll(Duration.of(500, ChronoUnit.MILLIS)); for (ConsumerRecord\u003cString, String\u003e record : records) { System.out.format(\"offset: %d\\n\", record.offset()); System.out.format(\"partition: %d\\n\", record.partition()); System.out.format(\"timestamp: %d\\n\", record.timestamp()); System.out.format(\"timeStamppType: %d\\n\", record.timestampType()); System.out.format(\"topic: %d\\n\", record.topic()); System.out.format(\"key: %d\\n\", record.key()); System.out.format(\"value: %d\\n\", record.value()); } } Close the consumer:\nconsumer.close(); Rebalance Regardless of what a consumer is doing, at regular intervals, which are configurable, they send a heartbeat to Kafka. Specifically to the coordinator inside the broker, basically letting them know they are alive. Also, when we poll for records, that lets Kafka know what consumer is alive. When you close a consumer, that close() method lets Kafka know they are not alive anymore, which triggers a rebalance. Sample Code package com.globomantics; import org.apache.kafka.clients.consumer.ConsumerConfig; import org.apache.kafka.clients.consumer.ConsumerRecord; import org.apache.kafka.clients.consumer.ConsumerRecords; import org.apache.kafka.clients.consumer.KafkaConsumer; import org.apache.kafka.common.serialization.DoubleDeserializer; import org.apache.kafka.common.serialization.StringDeserializer; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import java.time.Duration; import java.util.Collections; import java.util.Properties; public class Consumer { private static final Logger log = LoggerFactory.getLogger(Consumer.class); public static void main(String[] args) { Properties props = new Properties(); props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, \"http://localhost:9092,http://localhost:9093,http://localhost:9094\"); props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName()); props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, DoubleDeserializer.class.getName()); props.put(ConsumerConfig.GROUP_ID_CONFIG, args[0] + \"consumer\"); KafkaConsumer\u003cString, Double\u003e consumer = new KafkaConsumer\u003c\u003e(props); Thread haltedHook = new Thread(consumer::close); Runtime.getRuntime().addShutdownHook(haltedHook); consumer.subscribe(Collections.singletonList(\"myorders\")); while (true) { ConsumerRecords\u003cString, Double\u003e records = consumer.poll(Duration.ofMillis(100)); records.forEach(Consumer::processRecord); } } private static void processRecord(ConsumerRecord record) { log.info(\"Received message with key: \" + record.key() + \" and value \" + record.value()); log.info(\"It comes from partition: \" + record.partition()); try { Thread.sleep(1000); } catch (InterruptedException e) { System.out.println(e.getMessage()); } } } Demo Run composed containers using the same yaml file:\ndocker compose up -d create a topic myorders with four partitions:\nkafka-topics.sh --create --bootstrap-server localhost:9092 \\ --partitions 4 --topic myorders Run two consumers in two terminals with the same command:\nmvn clean install exec:java -Dexec.mainClass=\"com.globomantics.Consumer\" -Dexec.args=\"1\" We can check the running consumers by checking the log of each broker:\ndocker logs broker-1 If any broker shows a log like the following, the two consumers are alive and assigned to this broker:\n[2024-11-20 16:01:51,462] INFO [GroupCoordinator 2]: Assignment received from leader consumer-1consumer-1-ec9ee2fb-587c-44ad-bd09-be2b75182295 for group 1consumer for generation 2. The group has 2 members, 0 of which are static. (kafka.coordinator.group.GroupCoordinator) Run a producer by the following Producer class, which send messages to the topic myorders:\npackage com.globomantics; import org.apache.kafka.clients.producer.KafkaProducer; import org.apache.kafka.clients.producer.ProducerConfig; import org.apache.kafka.clients.producer.ProducerRecord; import org.apache.kafka.common.serialization.DoubleSerializer; import org.apache.kafka.common.serialization.StringSerializer; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import java.util.Properties; public class Producer { private static final Logger log = LoggerFactory.getLogger(Producer.class); private static final String TOPIC = \"myorders\"; public static void main(String[] args) throws InterruptedException { Properties props = new Properties(); props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, \"http://localhost:9092,http://localhost:9093,http://localhost:9094\"); props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName()); props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, DoubleSerializer.class.getName()); KafkaProducer\u003cString, Double\u003e producer = new KafkaProducer\u003c\u003e(props); String stateString = \"AK,AL,AZ,AR,CA,CO,CT,DE,FL,GA,\" + \"HI,ID,IL,IN,IA,KS,KY,LA,ME,MD,\" + \"MA,MI,MN,MS,MO,MT,NE,NV,NH,NJ,\" + \"NM,NY,NC,ND,OH,OK,OR,PA,RI,SC,\" + \"SD,TN,TX,UT,VT,VA,WA,WV,WI,WY\"; String[] stateArray = stateString.split(\",\"); for (int i = 0; i \u003c 25000; i++) { String key = stateArray[(int) Math.floor(Math.random()*(50))]; double value = Math.floor(Math.random()* (10000-10+1)+10); ProducerRecord\u003cString, Double\u003e producerRecord = new ProducerRecord\u003c\u003e(TOPIC, key, value); log.info(\"Sending message with key \" + key + \" to Kafka\"); producer.send(producerRecord, (metadata, e) -\u003e { if (metadata != null) { System.out.println(producerRecord.key()); System.out.println(producerRecord.value()); System.out.println(metadata.toString()); } }); Thread.sleep(5000); } producer.flush(); producer.close(); log.info(\"Successfully produced messages to \" + TOPIC + \" topic\"); } } We can see that the consumer 1 received messages from partitions 0 and 1:\n[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: KS and value 9144.0 [com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 1 [com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: MS and value 4089.0 [com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 0 And, consumer 2 received messages from partitions 2 and 3:\n[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: UT and value 1539.0 [com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 2 [com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: IA and value 9049.0 [com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 3 We can chek the detail of consumer groups:\n❯ kafka-consumer-groups.sh --all-groups --all-topics --bootstrap-server localhost:9092 --describe GROUP TOPIC PARTITION CURRENT-OFFSET LOG-END-OFFSET LAG CONSUMER-ID HOST CLIENT-ID 1consumer myorders 2 2 2 0 consumer-1consumer-1-ec9ee2fb-587c-44ad-bd09-be2b75182295 /172.19.0.1 consumer-1consumer-1 1consumer myorders 3 1 1 0 consumer-1consumer-1-ec9ee2fb-587c-44ad-bd09-be2b75182295 /172.19.0.1 consumer-1consumer-1 1consumer myorders 1 2 2 0 consumer-1consumer-1-41553fd9-436f-459f-8345-84cac011a51d /172.19.0.1 consumer-1consumer-1 1consumer myorders 0 2 2 0 consumer-1consumer-1-41553fd9-436f-459f-8345-84cac011a51d /172.19.0.1 consumer-1consumer-1% We can see that the partitions 0 and 1 are assigned to a same consumer, and the partitions 2 and 3 are assigned to the same consumers.\nThen let’s run the third consumer by the same command:\nmvn clean install exec:java -Dexec.mainClass=\"com.globomantics.Consumer\" -Dexec.args=\"1\" Now, we can see something like the consumer 2 only received messages from partition 3:\n[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: MA and value 202.0 [com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 3 [com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: FL and value 4078.0 [com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 3 And, the new joining consumer 3 only received messages from partition 2:\n[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: MN and value 8388.0 [com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 2 [com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: CT and value 1375.0 [com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 2 The new consumer 3 shared the load of consumer 2.\nWe can also check the consumer groups again:\n❯ kafka-consumer-groups.sh --all-groups --all-topics --bootstrap-server localhost:9092 --describe GROUP TOPIC PARTITION CURRENT-OFFSET LOG-END-OFFSET LAG CONSUMER-ID HOST CLIENT-ID 1consumer myorders 1 24 24 0 consumer-1consumer-1-41553fd9-436f-459f-8345-84cac011a51d /172.19.0.1 consumer-1consumer-1 1consumer myorders 0 20 20 0 consumer-1consumer-1-41553fd9-436f-459f-8345-84cac011a51d /172.19.0.1 consumer-1consumer-1 1consumer myorders 3 29 30 1 consumer-1consumer-1-ec9ee2fb-587c-44ad-bd09-be2b75182295 /172.19.0.1 consumer-1consumer-1 1consumer myorders 2 16 16 0 consumer-1consumer-1-9bf052d6-4197-4c00-b327-8cc1f13662c4 /172.19.0.1 consumer-1consumer-1% We can see that partition 3 is assigned to only one consumer, and partition 2 is assigned to the other new joining consumer.\nWe can also check the log of broker 2 (or maybe in other broker):\n[2024-11-20 16:22:22,217] INFO [GroupCoordinator 2]: Dynamic member with unknown member id joins group 1consumer in Stable state. Created a new member id consumer-1consumer-1-9bf052d6-4197-4c00-b327-8cc1f13662c4 and request the member to rejoin with this id. (kafka.coordinator.group.GroupCoordinator) [2024-11-20 16:22:22,234] INFO [GroupCoordinator 2]: Preparing to rebalance group 1consumer in state PreparingRebalance with old generation 2 (__consumer_offsets-7) (reason: Adding new member consumer-1consumer-1-9bf052d6-4197-4c00-b327-8cc1f13662c4 with group instance id None; client reason: rebalance failed due to MemberIdRequiredException) (kafka.coordinator.group.GroupCoordinator) The group is rebalanced due to a new consumer joining in.\nTakeaways Consumers act as a group via the consumer group ID. Each consumer in the group gets assigned a partition, and a partition is not shared by two members of a group. A rebalance is triggered when a member leaves the group or they haven’t sent a heartbeat in a long time. A rebalance is a stop-the-world event that ensures all partitions are attended by some consumer in the group. Keys Be sure to configure your consumer to ensure you are not duplicating messages. Try to create a consumer loop with two consumers and verify the partition assignment by playing with keys in the producer. See what happens in the logs of the broker when a consumer joins or leaves the group. ",
  "wordCount" : "2093",
  "inLanguage": "en",
  "datePublished": "2024-11-18T18:41:00+08:00",
  "dateModified": "2024-11-18T18:41:00+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://zjxjwxk.github.io/posts/mq/kafka/getting-started-with-apache-kafka/4-kafka-conumers/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Xinkang's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://zjxjwxk.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://zjxjwxk.github.io/" accesskey="h" title="Xinkang&#39;s Blog (Alt + H)">Xinkang&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://zjxjwxk.github.io/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://zjxjwxk.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://zjxjwxk.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://zjxjwxk.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://zjxjwxk.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://zjxjwxk.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Kafka Consumer
    </h1>
    <div class="post-meta"><span title='2024-11-18 18:41:00 +0800 CST'>November 18, 2024</span>&nbsp;·&nbsp;10 min&nbsp;|&nbsp;<a href="https://github.com/zjxjwxk/zjxjwxk.github.io/tree/main/content/posts/MQ/Kafka/Getting%20Started%20with%20Apache%20Kafka/4-Kafka%20Conumers/index.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#kafka-consumer-group" aria-label="Kafka Consumer Group">Kafka Consumer Group</a></li>
                <li>
                    <a href="#demo-consuming-from-kafka" aria-label="Demo: Consuming from Kafka">Demo: Consuming from Kafka</a><ul>
                        
                <li>
                    <a href="#run-kafka-containers" aria-label="Run Kafka Containers">Run Kafka Containers</a></li>
                <li>
                    <a href="#create-topic" aria-label="Create Topic">Create Topic</a></li>
                <li>
                    <a href="#run-consumer" aria-label="Run Consumer">Run Consumer</a></li>
                <li>
                    <a href="#send-messages" aria-label="Send Messages">Send Messages</a></li></ul>
                </li>
                <li>
                    <a href="#demo-consuming-messages-with-java" aria-label="Demo: Consuming Messages with Java">Demo: Consuming Messages with Java</a><ul>
                        
                <li>
                    <a href="#deserializers-and-consumer-configuration" aria-label="Deserializers and Consumer Configuration">Deserializers and Consumer Configuration</a></li>
                <li>
                    <a href="#rebalance" aria-label="Rebalance">Rebalance</a></li>
                <li>
                    <a href="#sample-code" aria-label="Sample Code">Sample Code</a></li>
                <li>
                    <a href="#demo" aria-label="Demo">Demo</a></li></ul>
                </li>
                <li>
                    <a href="#takeaways" aria-label="Takeaways">Takeaways</a></li>
                <li>
                    <a href="#keys" aria-label="Keys">Keys</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="kafka-consumer-group">Kafka Consumer Group<a hidden class="anchor" aria-hidden="true" href="#kafka-consumer-group">#</a></h2>
<ul>
<li>Consumers are typically done as a group.</li>
<li>A single consumer will end up inefficient with large amounts of data.</li>
<li>A consumer may never catch up.</li>
<li>Every consumer should be on it&rsquo;s own machine, instance, pod.</li>
</ul>
<p>The consumer group ID is the key so Kafka knows that messages should be distributed to both consumers without duplicating.</p>
<p><img alt="image-20241118185205006" loading="lazy" src="/posts/mq/kafka/getting-started-with-apache-kafka/4-kafka-conumers/images/image-20241118185205006.png"></p>
<p>If we add one more consumer to this group, the last one will be idle, because one partition can&rsquo;t be share across consumers. One partition can only be assigned to one consumer. Instead, the partitions are the way of Kafka to scale. More partitions imply you can have more consumers in the same consumer group.</p>
<p><img alt="image-20241118185601440" loading="lazy" src="/posts/mq/kafka/getting-started-with-apache-kafka/4-kafka-conumers/images/image-20241118185601440.png"></p>
<h2 id="demo-consuming-from-kafka">Demo: Consuming from Kafka<a hidden class="anchor" aria-hidden="true" href="#demo-consuming-from-kafka">#</a></h2>
<h3 id="run-kafka-containers">Run Kafka Containers<a hidden class="anchor" aria-hidden="true" href="#run-kafka-containers">#</a></h3>
<p>Create a docker-compose file <code>docker-compose.yaml</code> containing three Zookeepers, three Kafka Brokers, and a Kafka REST Proxy:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">zookeeper-1</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">confluentinc/cp-zookeeper:7.4.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">zookeeper-1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">zookeeper-1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./zookeeper-1_data:/var/lib/zookeeper/data</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./zookeeper-1_log:/var/lib/zookeeper/log</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ZOOKEEPER_CLIENT_PORT</span>: <span style="color:#ae81ff">2181</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ZOOKEEPER_TICK_TIME</span>: <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ZOO_MY_ID</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ZOO_SERVERS</span>: <span style="color:#ae81ff">server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">zookeeper-2</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">confluentinc/cp-zookeeper:7.4.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">zookeeper-2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">zookeeper-2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./zookeeper-2_data:/var/lib/zookeeper/data</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./zookeeper-2_log:/var/lib/zookeeper/log</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ZOOKEEPER_CLIENT_PORT</span>: <span style="color:#ae81ff">2181</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ZOOKEEPER_TICK_TIME</span>: <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ZOO_MY_ID</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ZOO_SERVERS</span>: <span style="color:#ae81ff">server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">zookeeper-3</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">confluentinc/cp-zookeeper:7.4.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">zookeeper-3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">zookeeper-3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./zookeeper-3_data:/var/lib/zookeeper/data</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./zookeeper-3_log:/var/lib/zookeeper/log</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ZOOKEEPER_CLIENT_PORT</span>: <span style="color:#ae81ff">2181</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ZOOKEEPER_TICK_TIME</span>: <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ZOO_MY_ID</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">ZOO_SERVERS</span>: <span style="color:#ae81ff">server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">broker-1</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">confluentinc/cp-kafka:7.4.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">broker-1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">broker-1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./broker-1-data:/var/lib/kafka/data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">zookeeper-1</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">zookeeper-2</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">zookeeper-3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">9092</span>:<span style="color:#ae81ff">9092</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">29092</span>:<span style="color:#ae81ff">29092</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_BROKER_ID</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_ZOOKEEPER_CONNECT</span>: <span style="color:#ae81ff">zookeeper-1:2181</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_ADVERTISED_LISTENERS</span>: <span style="color:#ae81ff">HOST://localhost:9092,INTERNAL://broker-1:29092</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span>: <span style="color:#ae81ff">HOST:PLAINTEXT,INTERNAL:PLAINTEXT</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_INTER_BROKER_LISTENER_NAME</span>: <span style="color:#ae81ff">INTERNAL</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_SNAPSHOT_TRUST_EMPTY</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">broker-2</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">confluentinc/cp-kafka:7.4.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">broker-2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">broker-2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./broker-2-data:/var/lib/kafka/data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">zookeeper-1</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">zookeeper-2</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">zookeeper-3</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">broker-1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">9093</span>:<span style="color:#ae81ff">9093</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">29093</span>:<span style="color:#ae81ff">29093</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_BROKER_ID</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_ZOOKEEPER_CONNECT</span>: <span style="color:#ae81ff">zookeeper-1:2181</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_ADVERTISED_LISTENERS</span>: <span style="color:#ae81ff">HOST://localhost:9093,INTERNAL://broker-2:29093</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span>: <span style="color:#ae81ff">HOST:PLAINTEXT,INTERNAL:PLAINTEXT</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_INTER_BROKER_LISTENER_NAME</span>: <span style="color:#ae81ff">INTERNAL</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_SNAPSHOT_TRUST_EMPTY</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">broker-3</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">confluentinc/cp-kafka:7.4.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">broker-3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">broker-3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./broker-3-data:/var/lib/kafka/data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">zookeeper-1</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">zookeeper-2</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">zookeeper-3</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">broker-1</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">broker-2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">9094</span>:<span style="color:#ae81ff">9094</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">29094</span>:<span style="color:#ae81ff">29094</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_BROKER_ID</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_ZOOKEEPER_CONNECT</span>: <span style="color:#ae81ff">zookeeper-1:2181</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_ADVERTISED_LISTENERS</span>: <span style="color:#ae81ff">HOST://localhost:9094,INTERNAL://broker-3:29094</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span>: <span style="color:#ae81ff">HOST:PLAINTEXT,INTERNAL:PLAINTEXT</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_INTER_BROKER_LISTENER_NAME</span>: <span style="color:#ae81ff">INTERNAL</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_SNAPSHOT_TRUST_EMPTY</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rest-proxy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">confluentinc/cp-kafka-rest:7.4.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;8082:8082&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">zookeeper-1</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">zookeeper-2</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">zookeeper-3</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">broker-1</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">broker-2</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">broker-3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostname</span>: <span style="color:#ae81ff">rest-proxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">rest-proxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_REST_HOST_NAME</span>: <span style="color:#ae81ff">rest-proxy</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_REST_BOOTSTRAP_SERVERS</span>: <span style="color:#e6db74">&#39;broker-1:29092,broker-2:29093,broker-3:29094&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KAFKA_REST_LISTENERS</span>: <span style="color:#e6db74">&#34;http://0.0.0.0:8082&#34;</span>
</span></span></code></pre></div><p>Run composed containers:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker compose up -d
</span></span></code></pre></div><h3 id="create-topic">Create Topic<a hidden class="anchor" aria-hidden="true" href="#create-topic">#</a></h3>
<p>Create a topic <code>myorders</code> with 2 partitions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kafka-topics.sh --create --bootstrap-server localhost:9092 --partitions <span style="color:#ae81ff">2</span> --topic myorders
</span></span></code></pre></div><h3 id="run-consumer">Run Consumer<a hidden class="anchor" aria-hidden="true" href="#run-consumer">#</a></h3>
<p>Run 3 Kafka Consumers in different terminals lisitening to the same topic <code>myorders</code> and deserialize the messages by string key and double value seperated by <code>,</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kafka-console-consumer.sh <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--topic myorders --from-beginning <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key-deserializer org.apache.kafka.common.serialization.StringDeserializer <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--value-deserializer org.apache.kafka.common.serialization.DoubleDeserializer <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--property print.key<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--property key.separator<span style="color:#f92672">=</span>, <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--group <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>Then, in another terminal, run another consumer with all the other same parameters but with <code>--group 2</code>.</p>
<p>We can see check the logs of broker 1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker logs broker-1
</span></span></code></pre></div><p>The following log can be found, which means there are three members in the group 1:</p>
<pre tabindex="0"><code>[2024-11-18 14:36:14,337] INFO [GroupCoordinator 1]: Stabilized group 1 generation 3 (__consumer_offsets-49) with 3 members (kafka.coordinator.group.GroupCoordinator)
[2024-11-18 14:36:14,346] INFO [GroupCoordinator 1]: Assignment received from leader console-consumer-340e7131-cbd4-4811-a62a-543fbac93948 for group 1 for generation 3. The group has 3 members, 0 of which are static. (kafka.coordinator.group.GroupCoordinator)
</code></pre><p>And in the logs of broker 2 (or 3), we can see that there is one consumer in the group 2:</p>
<pre tabindex="0"><code>[2024-11-18 14:38:49,987] INFO [GroupCoordinator 3]: Stabilized group 2 generation 1 (__consumer_offsets-0) with 1 members (kafka.coordinator.group.GroupCoordinator)
[2024-11-18 14:38:50,050] INFO [GroupCoordinator 3]: Assignment received from leader console-consumer-bebf5e94-8479-4ab8-b078-ced3f0d81d4c for group 2 for generation 1. The group has 1 members, 0 of which are static. (kafka.coordinator.group.GroupCoordinator)
</code></pre><h3 id="send-messages">Send Messages<a hidden class="anchor" aria-hidden="true" href="#send-messages">#</a></h3>
<p>Run the following Java method to send messages to the topic <code>myorders</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Main</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger log <span style="color:#f92672">=</span> LoggerFactory.<span style="color:#a6e22e">getLogger</span>(Main.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String TOPIC <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;myorders&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> InterruptedException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Properties props <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Properties();
</span></span><span style="display:flex;"><span>		props.<span style="color:#a6e22e">put</span>(ProducerConfig.<span style="color:#a6e22e">BOOTSTRAP_SERVERS_CONFIG</span>, <span style="color:#e6db74">&#34;http://localhost:9092,http://localhost:9093,http://localhost:9094&#34;</span>);
</span></span><span style="display:flex;"><span>		props.<span style="color:#a6e22e">put</span>(ProducerConfig.<span style="color:#a6e22e">KEY_SERIALIZER_CLASS_CONFIG</span>, StringSerializer.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getName</span>());
</span></span><span style="display:flex;"><span>		props.<span style="color:#a6e22e">put</span>(ProducerConfig.<span style="color:#a6e22e">VALUE_SERIALIZER_CLASS_CONFIG</span>, DoubleSerializer.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getName</span>());
</span></span><span style="display:flex;"><span>		KafkaProducer<span style="color:#f92672">&lt;</span>String, Double<span style="color:#f92672">&gt;</span> producer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> KafkaProducer<span style="color:#f92672">&lt;&gt;</span>(props);
</span></span><span style="display:flex;"><span>		String stateString <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">&#34;AK,AL,AZ,AR,CA,CO,CT,DE,FL,GA,&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>						<span style="color:#e6db74">&#34;HI,ID,IL,IN,IA,KS,KY,LA,ME, MD,&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>						<span style="color:#e6db74">&#34;MA,MI,MN,MS,MO,MT,NE,NV,NH,NJ,&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>						<span style="color:#e6db74">&#34;NM,NY,NC,ND,OH,OK,OR,PA,RI,SC,&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>						<span style="color:#e6db74">&#34;SD,TN,TX,UT,VT,VA,WA,WV,WI,WY&#34;</span>;
</span></span><span style="display:flex;"><span>		String<span style="color:#f92672">[]</span> stateArray <span style="color:#f92672">=</span> stateString.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;,&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0; i <span style="color:#f92672">&lt;</span> 25000; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>			String key <span style="color:#f92672">=</span> stateArray<span style="color:#f92672">[</span>(<span style="color:#66d9ef">int</span>) Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>()<span style="color:#f92672">*</span>(50))<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">double</span> value <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>()<span style="color:#f92672">*</span> (10000<span style="color:#f92672">-</span>10<span style="color:#f92672">+</span>1)<span style="color:#f92672">+</span>10);
</span></span><span style="display:flex;"><span>			ProducerRecord<span style="color:#f92672">&lt;</span>String, Double<span style="color:#f92672">&gt;</span> producerRecord <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">new</span> ProducerRecord<span style="color:#f92672">&lt;&gt;</span>(TOPIC, key, value);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Sending message with key &#34;</span> <span style="color:#f92672">+</span> key <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; to Kafka&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			producer.<span style="color:#a6e22e">send</span>(producerRecord, (metadata, e) <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (metadata <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>					System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(producerRecord.<span style="color:#a6e22e">key</span>());
</span></span><span style="display:flex;"><span>					System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(producerRecord.<span style="color:#a6e22e">value</span>());
</span></span><span style="display:flex;"><span>					System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(metadata.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			});
</span></span><span style="display:flex;"><span>			Thread.<span style="color:#a6e22e">sleep</span>(5000);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		producer.<span style="color:#a6e22e">flush</span>();
</span></span><span style="display:flex;"><span>		producer.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Successfully produced messages to &#34;</span> <span style="color:#f92672">+</span> TOPIC <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; topic&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can see that the consumer in the group 2 read all messages:</p>
<pre tabindex="0"><code>MT,4138.0
LA,6868.0
KS,6318.0
MA,6184.0
NM,8817.0
NJ,6606.0
NV,9748.0
</code></pre><p>The consumer 1 in the group 1:</p>
<pre tabindex="0"><code>MT,4138.0
NV,9748.0
</code></pre><p>The consumer 2 (or 3) in the group 2:</p>
<pre tabindex="0"><code>LA,6868.0
KS,6318.0
MA,6184.0
NM,8817.0
NJ,6606.0
</code></pre><p>But consumer 3 (or 2) in the group 3 doesn&rsquo;t read any message. That&rsquo;s because there are only two partitions, which has been assigned to the other two consumers. So this consumer is idle. <strong>One partition can only be assigned to one consumer.</strong></p>
<p>We can chek the detail of consumer groups:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ kafka-consumer-groups.sh --all-groups --all-topics --bootstrap-server localhost:9092 --describe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                           HOST            CLIENT-ID
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>               myorders        <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">13</span>              <span style="color:#ae81ff">13</span>              <span style="color:#ae81ff">0</span>               console-consumer-340e7131-cbd4-4811-a62a-543fbac93948 /172.18.0.1     console-consumer
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>               myorders        <span style="color:#ae81ff">1</span>          <span style="color:#ae81ff">16</span>              <span style="color:#ae81ff">16</span>              <span style="color:#ae81ff">0</span>               console-consumer-68f58739-69be-4f48-af94-590ee15add84 /172.18.0.1     console-consumer
</span></span><span style="display:flex;"><span>GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                           HOST            CLIENT-ID
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>               myorders        <span style="color:#ae81ff">1</span>          <span style="color:#ae81ff">16</span>              <span style="color:#ae81ff">16</span>              <span style="color:#ae81ff">0</span>               console-consumer-bebf5e94-8479-4ab8-b078-ced3f0d81d4c /172.18.0.1     console-consumer
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>               myorders        <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">13</span>              <span style="color:#ae81ff">13</span>              <span style="color:#ae81ff">0</span>               console-consumer-bebf5e94-8479-4ab8-b078-ced3f0d81d4c /172.18.0.1     console-consumer%
</span></span></code></pre></div><p>We can see that in the group 1, these two partitions are assigned to two different consumers. But in the group2, these two partitions are assigned to the same consumer.</p>
<h2 id="demo-consuming-messages-with-java">Demo: Consuming Messages with Java<a hidden class="anchor" aria-hidden="true" href="#demo-consuming-messages-with-java">#</a></h2>
<h3 id="deserializers-and-consumer-configuration">Deserializers and Consumer Configuration<a hidden class="anchor" aria-hidden="true" href="#deserializers-and-consumer-configuration">#</a></h3>
<p>Provide two or more locations where the Bootstrap servers are located:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Properties properties <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Properties();
</span></span><span style="display:flex;"><span>properties.<span style="color:#a6e22e">put</span>(ConsumerConfig.<span style="color:#a6e22e">BOOTSTRAP_SERVERS_CONFIG</span>, <span style="color:#e6db74">&#34;localhost:9092&#34;</span>);
</span></span><span style="display:flex;"><span>properties.<span style="color:#a6e22e">put</span>(ConsumerConfig.<span style="color:#a6e22e">GROUP_ID_CONFIG</span>, <span style="color:#e6db74">&#34;my_group&#34;</span>);
</span></span><span style="display:flex;"><span>properties.<span style="color:#a6e22e">put</span>(ConsumerConfig.<span style="color:#a6e22e">KEY_DESERIALIZER_CLASS_CONFIG</span>, <span style="color:#e6db74">&#34;org.apache.kafka.common.serialization.StringDeserializer&#34;</span>);
</span></span><span style="display:flex;"><span>properties.<span style="color:#a6e22e">put</span>(ConsumerConfig.<span style="color:#a6e22e">VALUE_DESERIALIZER_CLASS_CONFIG</span>, <span style="color:#e6db74">&#34;org.apache.kafka,common,serialization.IntegerDeserializer&#34;</span>);
</span></span><span style="display:flex;"><span>properties.<span style="color:#a6e22e">put</span>(ConsumerConfig.<span style="color:#a6e22e">AUTO_OFFSET_RESET_CONFIG</span>, <span style="color:#e6db74">&#34;earliest&#34;</span>);
</span></span></code></pre></div><p>Construct a org.apache.kafka.clients.consumer.KafkaConsumer object:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>KafkaConsumer consumer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> KafkaConsumer<span style="color:#f92672">&lt;&gt;</span>(properties);
</span></span></code></pre></div><p>Use the consumer that you have constructed, and call poll with pulse time:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>done.<span style="color:#a6e22e">get</span>()) {
</span></span><span style="display:flex;"><span>  	ConsumerRecords<span style="color:#f92672">&lt;</span>String, String<span style="color:#f92672">&gt;</span> records <span style="color:#f92672">=</span> consumer.<span style="color:#a6e22e">poll</span>(Duration.<span style="color:#a6e22e">of</span>(500, ChronoUnit.<span style="color:#a6e22e">MILLIS</span>));
</span></span><span style="display:flex;"><span>  	<span style="color:#66d9ef">for</span> (ConsumerRecord<span style="color:#f92672">&lt;</span>String, String<span style="color:#f92672">&gt;</span> record : records) {
</span></span><span style="display:flex;"><span>      	System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;offset: %d\n&#34;</span>, record.<span style="color:#a6e22e">offset</span>());
</span></span><span style="display:flex;"><span>      	System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;partition: %d\n&#34;</span>, record.<span style="color:#a6e22e">partition</span>());
</span></span><span style="display:flex;"><span>      	System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;timestamp: %d\n&#34;</span>, record.<span style="color:#a6e22e">timestamp</span>());
</span></span><span style="display:flex;"><span>      	System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;timeStamppType: %d\n&#34;</span>, record.<span style="color:#a6e22e">timestampType</span>());
</span></span><span style="display:flex;"><span>      	System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;topic: %d\n&#34;</span>, record.<span style="color:#a6e22e">topic</span>());
</span></span><span style="display:flex;"><span>      	System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;key: %d\n&#34;</span>, record.<span style="color:#a6e22e">key</span>());
</span></span><span style="display:flex;"><span>      	System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;value: %d\n&#34;</span>, record.<span style="color:#a6e22e">value</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Close the consumer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>consumer.<span style="color:#a6e22e">close</span>();
</span></span></code></pre></div><h3 id="rebalance">Rebalance<a hidden class="anchor" aria-hidden="true" href="#rebalance">#</a></h3>
<ul>
<li>Regardless of what a consumer is doing, at regular intervals, which are configurable, they send a heartbeat to Kafka.</li>
<li>Specifically to the coordinator inside the broker, basically letting them know they are alive.</li>
<li>Also, when we poll for records, that lets Kafka know what consumer is alive.</li>
<li>When you close a consumer, that <code>close()</code> method lets Kafka know they are not alive anymore, which triggers a rebalance.</li>
</ul>
<h3 id="sample-code">Sample Code<a hidden class="anchor" aria-hidden="true" href="#sample-code">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.globomantics;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.kafka.common.serialization.DoubleDeserializer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.kafka.common.serialization.StringDeserializer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.Logger;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.LoggerFactory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.time.Duration;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Collections;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Properties;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Consumer</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger log <span style="color:#f92672">=</span> LoggerFactory.<span style="color:#a6e22e">getLogger</span>(Consumer.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Properties props <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Properties();
</span></span><span style="display:flex;"><span>		props.<span style="color:#a6e22e">put</span>(ConsumerConfig.<span style="color:#a6e22e">BOOTSTRAP_SERVERS_CONFIG</span>, <span style="color:#e6db74">&#34;http://localhost:9092,http://localhost:9093,http://localhost:9094&#34;</span>);
</span></span><span style="display:flex;"><span>		props.<span style="color:#a6e22e">put</span>(ConsumerConfig.<span style="color:#a6e22e">KEY_DESERIALIZER_CLASS_CONFIG</span>, StringDeserializer.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getName</span>());
</span></span><span style="display:flex;"><span>		props.<span style="color:#a6e22e">put</span>(ConsumerConfig.<span style="color:#a6e22e">VALUE_DESERIALIZER_CLASS_CONFIG</span>, DoubleDeserializer.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getName</span>());
</span></span><span style="display:flex;"><span>		props.<span style="color:#a6e22e">put</span>(ConsumerConfig.<span style="color:#a6e22e">GROUP_ID_CONFIG</span>, args<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;consumer&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		KafkaConsumer<span style="color:#f92672">&lt;</span>String, Double<span style="color:#f92672">&gt;</span> consumer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> KafkaConsumer<span style="color:#f92672">&lt;&gt;</span>(props);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Thread haltedHook <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread(consumer::close);
</span></span><span style="display:flex;"><span>		Runtime.<span style="color:#a6e22e">getRuntime</span>().<span style="color:#a6e22e">addShutdownHook</span>(haltedHook);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		consumer.<span style="color:#a6e22e">subscribe</span>(Collections.<span style="color:#a6e22e">singletonList</span>(<span style="color:#e6db74">&#34;myorders&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
</span></span><span style="display:flex;"><span>			ConsumerRecords<span style="color:#f92672">&lt;</span>String, Double<span style="color:#f92672">&gt;</span> records <span style="color:#f92672">=</span> consumer.<span style="color:#a6e22e">poll</span>(Duration.<span style="color:#a6e22e">ofMillis</span>(100));
</span></span><span style="display:flex;"><span>			records.<span style="color:#a6e22e">forEach</span>(Consumer::processRecord);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processRecord</span>(ConsumerRecord record) {
</span></span><span style="display:flex;"><span>		log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Received message with key: &#34;</span> <span style="color:#f92672">+</span> record.<span style="color:#a6e22e">key</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; and value &#34;</span> <span style="color:#f92672">+</span> record.<span style="color:#a6e22e">value</span>());
</span></span><span style="display:flex;"><span>		log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;It comes from partition: &#34;</span> <span style="color:#f92672">+</span> record.<span style="color:#a6e22e">partition</span>());
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>			Thread.<span style="color:#a6e22e">sleep</span>(1000);
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>			System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="demo">Demo<a hidden class="anchor" aria-hidden="true" href="#demo">#</a></h3>
<p>Run composed containers using the same yaml file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker compose up -d
</span></span></code></pre></div><p>create a topic <code>myorders</code> with four partitions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kafka-topics.sh --create --bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--partitions <span style="color:#ae81ff">4</span> --topic myorders
</span></span></code></pre></div><p>Run two consumers in two terminals with the same command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mvn clean install exec:java -Dexec.mainClass<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;com.globomantics.Consumer&#34;</span> -Dexec.args<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span>
</span></span></code></pre></div><p>We can check the running consumers by checking the log of each broker:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker logs broker-1
</span></span></code></pre></div><p>If any broker shows a log like the following, the two consumers are alive and assigned to this broker:</p>
<pre tabindex="0"><code>[2024-11-20 16:01:51,462] INFO [GroupCoordinator 2]: Assignment received from leader consumer-1consumer-1-ec9ee2fb-587c-44ad-bd09-be2b75182295 for group 1consumer for generation 2. The group has 2 members, 0 of which are static. (kafka.coordinator.group.GroupCoordinator)
</code></pre><p>Run a producer by the following Producer class, which send messages to the topic <code>myorders</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.globomantics;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.kafka.clients.producer.KafkaProducer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.kafka.clients.producer.ProducerConfig;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.kafka.clients.producer.ProducerRecord;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.kafka.common.serialization.DoubleSerializer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.kafka.common.serialization.StringSerializer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.Logger;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.LoggerFactory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Properties;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Producer</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger log <span style="color:#f92672">=</span> LoggerFactory.<span style="color:#a6e22e">getLogger</span>(Producer.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String TOPIC <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;myorders&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> InterruptedException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Properties props <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Properties();
</span></span><span style="display:flex;"><span>		props.<span style="color:#a6e22e">put</span>(ProducerConfig.<span style="color:#a6e22e">BOOTSTRAP_SERVERS_CONFIG</span>, <span style="color:#e6db74">&#34;http://localhost:9092,http://localhost:9093,http://localhost:9094&#34;</span>);
</span></span><span style="display:flex;"><span>		props.<span style="color:#a6e22e">put</span>(ProducerConfig.<span style="color:#a6e22e">KEY_SERIALIZER_CLASS_CONFIG</span>, StringSerializer.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getName</span>());
</span></span><span style="display:flex;"><span>		props.<span style="color:#a6e22e">put</span>(ProducerConfig.<span style="color:#a6e22e">VALUE_SERIALIZER_CLASS_CONFIG</span>, DoubleSerializer.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getName</span>());
</span></span><span style="display:flex;"><span>		KafkaProducer<span style="color:#f92672">&lt;</span>String, Double<span style="color:#f92672">&gt;</span> producer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> KafkaProducer<span style="color:#f92672">&lt;&gt;</span>(props);
</span></span><span style="display:flex;"><span>		String stateString <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">&#34;AK,AL,AZ,AR,CA,CO,CT,DE,FL,GA,&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>						<span style="color:#e6db74">&#34;HI,ID,IL,IN,IA,KS,KY,LA,ME,MD,&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>						<span style="color:#e6db74">&#34;MA,MI,MN,MS,MO,MT,NE,NV,NH,NJ,&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>						<span style="color:#e6db74">&#34;NM,NY,NC,ND,OH,OK,OR,PA,RI,SC,&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>						<span style="color:#e6db74">&#34;SD,TN,TX,UT,VT,VA,WA,WV,WI,WY&#34;</span>;
</span></span><span style="display:flex;"><span>		String<span style="color:#f92672">[]</span> stateArray <span style="color:#f92672">=</span> stateString.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;,&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0; i <span style="color:#f92672">&lt;</span> 25000; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>			String key <span style="color:#f92672">=</span> stateArray<span style="color:#f92672">[</span>(<span style="color:#66d9ef">int</span>) Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>()<span style="color:#f92672">*</span>(50))<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">double</span> value <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>()<span style="color:#f92672">*</span> (10000<span style="color:#f92672">-</span>10<span style="color:#f92672">+</span>1)<span style="color:#f92672">+</span>10);
</span></span><span style="display:flex;"><span>			ProducerRecord<span style="color:#f92672">&lt;</span>String, Double<span style="color:#f92672">&gt;</span> producerRecord <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">new</span> ProducerRecord<span style="color:#f92672">&lt;&gt;</span>(TOPIC, key, value);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Sending message with key &#34;</span> <span style="color:#f92672">+</span> key <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; to Kafka&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			producer.<span style="color:#a6e22e">send</span>(producerRecord, (metadata, e) <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (metadata <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>					System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(producerRecord.<span style="color:#a6e22e">key</span>());
</span></span><span style="display:flex;"><span>					System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(producerRecord.<span style="color:#a6e22e">value</span>());
</span></span><span style="display:flex;"><span>					System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(metadata.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			});
</span></span><span style="display:flex;"><span>			Thread.<span style="color:#a6e22e">sleep</span>(5000);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		producer.<span style="color:#a6e22e">flush</span>();
</span></span><span style="display:flex;"><span>		producer.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Successfully produced messages to &#34;</span> <span style="color:#f92672">+</span> TOPIC <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; topic&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can see that the consumer 1 received messages from partitions 0 and 1:</p>
<pre tabindex="0"><code>[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: KS and value 9144.0
[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 1
[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: MS and value 4089.0
[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 0
</code></pre><p>And, consumer 2 received messages from partitions 2 and 3:</p>
<pre tabindex="0"><code>[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: UT and value 1539.0
[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 2
[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: IA and value 9049.0
[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 3
</code></pre><p>We can chek the detail of consumer groups:</p>
<pre tabindex="0"><code>❯ kafka-consumer-groups.sh --all-groups --all-topics --bootstrap-server localhost:9092 --describe  

GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                               HOST            CLIENT-ID
1consumer       myorders        2          2               2               0               consumer-1consumer-1-ec9ee2fb-587c-44ad-bd09-be2b75182295 /172.19.0.1     consumer-1consumer-1
1consumer       myorders        3          1               1               0               consumer-1consumer-1-ec9ee2fb-587c-44ad-bd09-be2b75182295 /172.19.0.1     consumer-1consumer-1
1consumer       myorders        1          2               2               0               consumer-1consumer-1-41553fd9-436f-459f-8345-84cac011a51d /172.19.0.1     consumer-1consumer-1
1consumer       myorders        0          2               2               0               consumer-1consumer-1-41553fd9-436f-459f-8345-84cac011a51d /172.19.0.1     consumer-1consumer-1%
</code></pre><p>We can see that the partitions 0 and 1 are assigned to a same consumer, and the partitions 2 and 3 are assigned to the same consumers.</p>
<p>Then let&rsquo;s run the third consumer by the same command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mvn clean install exec:java -Dexec.mainClass<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;com.globomantics.Consumer&#34;</span> -Dexec.args<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span>
</span></span></code></pre></div><p>Now, we can see something like the consumer 2 only received messages from partition 3:</p>
<pre tabindex="0"><code>[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: MA and value 202.0
[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 3
[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: FL and value 4078.0
[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 3
</code></pre><p>And, the new joining consumer 3 only received messages from partition 2:</p>
<pre tabindex="0"><code>[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: MN and value 8388.0
[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 2
[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - Received message with key: CT and value 1375.0
[com.globomantics.Consumer.main()] INFO com.globomantics.Consumer - It comes from partition: 2
</code></pre><p>The new consumer 3 shared the load of consumer 2.</p>
<p>We can also check the consumer groups again:</p>
<pre tabindex="0"><code>❯ kafka-consumer-groups.sh --all-groups --all-topics --bootstrap-server localhost:9092 --describe

GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                               HOST            CLIENT-ID
1consumer       myorders        1          24              24              0               consumer-1consumer-1-41553fd9-436f-459f-8345-84cac011a51d /172.19.0.1     consumer-1consumer-1
1consumer       myorders        0          20              20              0               consumer-1consumer-1-41553fd9-436f-459f-8345-84cac011a51d /172.19.0.1     consumer-1consumer-1
1consumer       myorders        3          29              30              1               consumer-1consumer-1-ec9ee2fb-587c-44ad-bd09-be2b75182295 /172.19.0.1     consumer-1consumer-1
1consumer       myorders        2          16              16              0               consumer-1consumer-1-9bf052d6-4197-4c00-b327-8cc1f13662c4 /172.19.0.1     consumer-1consumer-1%
</code></pre><p>We can see that partition 3 is assigned to only one consumer, and partition 2 is assigned to the other new joining consumer.</p>
<p>We can also check the log of broker 2 (or maybe in other broker):</p>
<pre tabindex="0"><code>[2024-11-20 16:22:22,217] INFO [GroupCoordinator 2]: Dynamic member with unknown member id joins group 1consumer in Stable state. Created a new member id consumer-1consumer-1-9bf052d6-4197-4c00-b327-8cc1f13662c4 and request the member to rejoin with this id. (kafka.coordinator.group.GroupCoordinator)
[2024-11-20 16:22:22,234] INFO [GroupCoordinator 2]: Preparing to rebalance group 1consumer in state PreparingRebalance with old generation 2 (__consumer_offsets-7) (reason: Adding new member consumer-1consumer-1-9bf052d6-4197-4c00-b327-8cc1f13662c4 with group instance id None; client reason: rebalance failed due to MemberIdRequiredException) (kafka.coordinator.group.GroupCoordinator)
</code></pre><p>The group is rebalanced due to a new consumer joining in.</p>
<h2 id="takeaways">Takeaways<a hidden class="anchor" aria-hidden="true" href="#takeaways">#</a></h2>
<ul>
<li>Consumers act as a group via the consumer group ID.</li>
<li>Each consumer in the group gets assigned a partition, and a partition is not shared by two members of  a group.</li>
<li>A rebalance is triggered when a member leaves the group or they haven&rsquo;t sent a heartbeat in a long time.</li>
<li>A rebalance is a stop-the-world event that ensures all partitions are attended by some consumer in the group.</li>
</ul>
<h2 id="keys">Keys<a hidden class="anchor" aria-hidden="true" href="#keys">#</a></h2>
<ul>
<li>Be sure to configure your consumer to ensure you are not duplicating messages.</li>
<li>Try to create a consumer loop with two consumers and verify the partition assignment by playing with keys in the producer.</li>
<li>See what happens in the logs of the broker when a consumer joins or leaves the group.</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://zjxjwxk.github.io/tags/mq/">MQ</a></li>
      <li><a href="https://zjxjwxk.github.io/tags/kafka/">Kafka</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://zjxjwxk.github.io/posts/mq/kafka/getting-started-with-apache-kafka/5-kafka-connect/">
    <span class="title">« Prev</span>
    <br>
    <span>Kafka Connect</span>
  </a>
  <a class="next" href="https://zjxjwxk.github.io/posts/mq/kafka/getting-started-with-apache-kafka/3-kafka-producer/">
    <span class="title">Next »</span>
    <br>
    <span>Kafka Producer</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Kafka Consumer on x"
            href="https://x.com/intent/tweet/?text=Kafka%20Consumer&amp;url=https%3a%2f%2fzjxjwxk.github.io%2fposts%2fmq%2fkafka%2fgetting-started-with-apache-kafka%2f4-kafka-conumers%2f&amp;hashtags=MQ%2cKafka">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Kafka Consumer on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fzjxjwxk.github.io%2fposts%2fmq%2fkafka%2fgetting-started-with-apache-kafka%2f4-kafka-conumers%2f&amp;title=Kafka%20Consumer&amp;summary=Kafka%20Consumer&amp;source=https%3a%2f%2fzjxjwxk.github.io%2fposts%2fmq%2fkafka%2fgetting-started-with-apache-kafka%2f4-kafka-conumers%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Kafka Consumer on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fzjxjwxk.github.io%2fposts%2fmq%2fkafka%2fgetting-started-with-apache-kafka%2f4-kafka-conumers%2f&title=Kafka%20Consumer">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Kafka Consumer on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fzjxjwxk.github.io%2fposts%2fmq%2fkafka%2fgetting-started-with-apache-kafka%2f4-kafka-conumers%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Kafka Consumer on whatsapp"
            href="https://api.whatsapp.com/send?text=Kafka%20Consumer%20-%20https%3a%2f%2fzjxjwxk.github.io%2fposts%2fmq%2fkafka%2fgetting-started-with-apache-kafka%2f4-kafka-conumers%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Kafka Consumer on telegram"
            href="https://telegram.me/share/url?text=Kafka%20Consumer&amp;url=https%3a%2f%2fzjxjwxk.github.io%2fposts%2fmq%2fkafka%2fgetting-started-with-apache-kafka%2f4-kafka-conumers%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Kafka Consumer on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Kafka%20Consumer&u=https%3a%2f%2fzjxjwxk.github.io%2fposts%2fmq%2fkafka%2fgetting-started-with-apache-kafka%2f4-kafka-conumers%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer><div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "xinkangwu" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="https://zjxjwxk.github.io/">Xinkang&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
